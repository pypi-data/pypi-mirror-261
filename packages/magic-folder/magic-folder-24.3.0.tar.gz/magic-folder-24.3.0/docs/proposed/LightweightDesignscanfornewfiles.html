<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_rl6vdisu7lga-5>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-2>li:before{content:"-  "}.lst-kix_rl6vdisu7lga-4>li:before{content:"-  "}.lst-kix_rl6vdisu7lga-8>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-3>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-6>li:before{content:"-  "}.lst-kix_rl6vdisu7lga-7>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-4>li:before{content:"-  "}.lst-kix_rl6vdisu7lga-6>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-5>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-7>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-8>li:before{content:"-  "}ul.lst-kix_2kvjyg2pkx3g-8{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-7{list-style-type:none}ul.lst-kix_knv9hvmv5v30-4{list-style-type:none}ul.lst-kix_knv9hvmv5v30-5{list-style-type:none}ul.lst-kix_knv9hvmv5v30-2{list-style-type:none}ul.lst-kix_knv9hvmv5v30-3{list-style-type:none}ul.lst-kix_knv9hvmv5v30-0{list-style-type:none}ul.lst-kix_knv9hvmv5v30-1{list-style-type:none}.lst-kix_2kvjyg2pkx3g-1>li:before{content:"-  "}.lst-kix_2kvjyg2pkx3g-0>li:before{content:"-  "}.lst-kix_2kvjyg2pkx3g-2>li:before{content:"-  "}ul.lst-kix_oejw0yw2lfsb-2{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-1{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-4{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-3{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-0{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-6{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-5{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-8{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-7{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-5{list-style-type:none}ul.lst-kix_24t77lbu9guo-5{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-6{list-style-type:none}ul.lst-kix_24t77lbu9guo-4{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-7{list-style-type:none}ul.lst-kix_24t77lbu9guo-7{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-8{list-style-type:none}ul.lst-kix_24t77lbu9guo-6{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-1{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-2{list-style-type:none}ul.lst-kix_24t77lbu9guo-8{list-style-type:none}ul.lst-kix_oejw0yw2lfsb-0{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-3{list-style-type:none}ul.lst-kix_psdl1h1cd5l7-4{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-6{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-5{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-4{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-3{list-style-type:none}ul.lst-kix_24t77lbu9guo-1{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-2{list-style-type:none}ul.lst-kix_24t77lbu9guo-0{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-1{list-style-type:none}ul.lst-kix_24t77lbu9guo-3{list-style-type:none}ul.lst-kix_2kvjyg2pkx3g-0{list-style-type:none}ul.lst-kix_24t77lbu9guo-2{list-style-type:none}ul.lst-kix_h2evnjn3q36j-1{list-style-type:none}ul.lst-kix_h2evnjn3q36j-2{list-style-type:none}.lst-kix_ntqubcj0j1hx-3>li:before{content:"-  "}.lst-kix_ntqubcj0j1hx-4>li:before{content:"-  "}ul.lst-kix_h2evnjn3q36j-0{list-style-type:none}ul.lst-kix_h2evnjn3q36j-5{list-style-type:none}ul.lst-kix_h2evnjn3q36j-6{list-style-type:none}ul.lst-kix_h2evnjn3q36j-3{list-style-type:none}ul.lst-kix_h2evnjn3q36j-4{list-style-type:none}.lst-kix_ntqubcj0j1hx-0>li:before{content:"-  "}ul.lst-kix_h2evnjn3q36j-7{list-style-type:none}.lst-kix_ntqubcj0j1hx-8>li:before{content:"-  "}ul.lst-kix_h2evnjn3q36j-8{list-style-type:none}.lst-kix_ntqubcj0j1hx-1>li:before{content:"-  "}.lst-kix_ntqubcj0j1hx-2>li:before{content:"-  "}.lst-kix_h2evnjn3q36j-0>li:before{content:"-  "}.lst-kix_knv9hvmv5v30-4>li:before{content:"-  "}.lst-kix_knv9hvmv5v30-3>li:before{content:"-  "}.lst-kix_h2evnjn3q36j-1>li:before{content:"-  "}.lst-kix_h2evnjn3q36j-4>li:before{content:"-  "}.lst-kix_knv9hvmv5v30-1>li:before{content:"-  "}.lst-kix_knv9hvmv5v30-2>li:before{content:"-  "}.lst-kix_knv9hvmv5v30-0>li:before{content:"-  "}.lst-kix_h2evnjn3q36j-2>li:before{content:"-  "}.lst-kix_84lnh7u5mxb7-3>li:before{content:"-  "}.lst-kix_h2evnjn3q36j-3>li:before{content:"-  "}.lst-kix_h2evnjn3q36j-8>li:before{content:"-  "}.lst-kix_2kvjyg2pkx3g-8>li:before{content:"-  "}.lst-kix_84lnh7u5mxb7-2>li:before{content:"-  "}.lst-kix_84lnh7u5mxb7-1>li:before{content:"-  "}.lst-kix_h2evnjn3q36j-5>li:before{content:"-  "}.lst-kix_84lnh7u5mxb7-0>li:before{content:"-  "}.lst-kix_2kvjyg2pkx3g-5>li:before{content:"-  "}ul.lst-kix_84lnh7u5mxb7-8{list-style-type:none}.lst-kix_2kvjyg2pkx3g-4>li:before{content:"-  "}ul.lst-kix_84lnh7u5mxb7-6{list-style-type:none}.lst-kix_h2evnjn3q36j-6>li:before{content:"-  "}.lst-kix_2kvjyg2pkx3g-3>li:before{content:"-  "}ul.lst-kix_84lnh7u5mxb7-7{list-style-type:none}ul.lst-kix_84lnh7u5mxb7-4{list-style-type:none}.lst-kix_h2evnjn3q36j-7>li:before{content:"-  "}ul.lst-kix_84lnh7u5mxb7-5{list-style-type:none}ul.lst-kix_84lnh7u5mxb7-2{list-style-type:none}.lst-kix_knv9hvmv5v30-5>li:before{content:"-  "}ul.lst-kix_84lnh7u5mxb7-3{list-style-type:none}ul.lst-kix_84lnh7u5mxb7-0{list-style-type:none}.lst-kix_knv9hvmv5v30-6>li:before{content:"-  "}ul.lst-kix_84lnh7u5mxb7-1{list-style-type:none}.lst-kix_knv9hvmv5v30-7>li:before{content:"-  "}ul.lst-kix_knv9hvmv5v30-8{list-style-type:none}ul.lst-kix_knv9hvmv5v30-6{list-style-type:none}ul.lst-kix_knv9hvmv5v30-7{list-style-type:none}.lst-kix_knv9hvmv5v30-8>li:before{content:"-  "}.lst-kix_2kvjyg2pkx3g-6>li:before{content:"-  "}.lst-kix_2kvjyg2pkx3g-7>li:before{content:"-  "}.lst-kix_24t77lbu9guo-1>li:before{content:"-  "}.lst-kix_24t77lbu9guo-3>li:before{content:"-  "}.lst-kix_24t77lbu9guo-0>li:before{content:"-  "}.lst-kix_24t77lbu9guo-4>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-0>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-1>li:before{content:"-  "}.lst-kix_24t77lbu9guo-2>li:before{content:"-  "}.lst-kix_84lnh7u5mxb7-4>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-3>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-2>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-4>li:before{content:"-  "}ul.lst-kix_rl6vdisu7lga-0{list-style-type:none}.lst-kix_i55sx8bc07u6-1>li:before{content:"\0025cb  "}.lst-kix_84lnh7u5mxb7-6>li:before{content:"-  "}.lst-kix_84lnh7u5mxb7-5>li:before{content:"-  "}.lst-kix_i55sx8bc07u6-0>li:before{content:"\0025cf  "}.lst-kix_24t77lbu9guo-8>li:before{content:"-  "}.lst-kix_84lnh7u5mxb7-8>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-7>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-6>li:before{content:"-  "}.lst-kix_i55sx8bc07u6-3>li:before{content:"\0025cf  "}.lst-kix_24t77lbu9guo-5>li:before{content:"-  "}.lst-kix_24t77lbu9guo-7>li:before{content:"-  "}.lst-kix_oejw0yw2lfsb-5>li:before{content:"-  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_84lnh7u5mxb7-7>li:before{content:"-  "}.lst-kix_i55sx8bc07u6-2>li:before{content:"\0025a0  "}.lst-kix_24t77lbu9guo-6>li:before{content:"-  "}ul.lst-kix_i55sx8bc07u6-0{list-style-type:none}ul.lst-kix_ntqubcj0j1hx-5{list-style-type:none}ul.lst-kix_i55sx8bc07u6-1{list-style-type:none}ul.lst-kix_ntqubcj0j1hx-6{list-style-type:none}ul.lst-kix_ntqubcj0j1hx-7{list-style-type:none}.lst-kix_i55sx8bc07u6-7>li:before{content:"\0025cb  "}ul.lst-kix_ntqubcj0j1hx-8{list-style-type:none}ul.lst-kix_i55sx8bc07u6-4{list-style-type:none}ul.lst-kix_ntqubcj0j1hx-1{list-style-type:none}ul.lst-kix_i55sx8bc07u6-5{list-style-type:none}ul.lst-kix_ntqubcj0j1hx-2{list-style-type:none}.lst-kix_rl6vdisu7lga-0>li:before{content:"-  "}ul.lst-kix_i55sx8bc07u6-2{list-style-type:none}ul.lst-kix_ntqubcj0j1hx-3{list-style-type:none}ul.lst-kix_i55sx8bc07u6-3{list-style-type:none}.lst-kix_i55sx8bc07u6-4>li:before{content:"\0025cb  "}.lst-kix_i55sx8bc07u6-8>li:before{content:"\0025a0  "}ul.lst-kix_ntqubcj0j1hx-4{list-style-type:none}.lst-kix_rl6vdisu7lga-1>li:before{content:"-  "}ul.lst-kix_rl6vdisu7lga-5{list-style-type:none}ul.lst-kix_i55sx8bc07u6-8{list-style-type:none}.lst-kix_ntqubcj0j1hx-7>li:before{content:"-  "}ul.lst-kix_rl6vdisu7lga-6{list-style-type:none}ul.lst-kix_rl6vdisu7lga-7{list-style-type:none}.lst-kix_oejw0yw2lfsb-8>li:before{content:"-  "}ul.lst-kix_i55sx8bc07u6-6{list-style-type:none}ul.lst-kix_rl6vdisu7lga-8{list-style-type:none}.lst-kix_i55sx8bc07u6-5>li:before{content:"\0025a0  "}ul.lst-kix_i55sx8bc07u6-7{list-style-type:none}ul.lst-kix_ntqubcj0j1hx-0{list-style-type:none}ul.lst-kix_rl6vdisu7lga-1{list-style-type:none}.lst-kix_rl6vdisu7lga-3>li:before{content:"-  "}.lst-kix_psdl1h1cd5l7-0>li:before{content:"-  "}ul.lst-kix_rl6vdisu7lga-2{list-style-type:none}.lst-kix_ntqubcj0j1hx-5>li:before{content:"-  "}.lst-kix_ntqubcj0j1hx-6>li:before{content:"-  "}.lst-kix_rl6vdisu7lga-2>li:before{content:"-  "}ul.lst-kix_rl6vdisu7lga-3{list-style-type:none}.lst-kix_psdl1h1cd5l7-1>li:before{content:"-  "}ul.lst-kix_rl6vdisu7lga-4{list-style-type:none}.lst-kix_i55sx8bc07u6-6>li:before{content:"\0025cf  "}ol{margin:0;padding:0}table td,table th{padding:0}.c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.c23{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c2{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:23pt;font-family:"Arial";font-style:normal}.c1{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c3{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:13pt;font-family:"Arial";font-style:normal}.c6{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:17pt;font-family:"Arial";font-style:normal}.c24{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:21pt;font-family:"Trebuchet MS";font-style:normal}.c4{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c18{padding-top:24pt;padding-bottom:6pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c11{padding-top:0pt;padding-bottom:0pt;line-height:1.1500000000000001;orphans:2;widows:2;text-align:left}.c12{padding-top:0pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c10{padding-top:14pt;padding-bottom:4pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c13{padding-top:18pt;padding-bottom:4pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c19{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c20{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c15{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c25{margin-left:144pt;padding-left:0pt}.c8{margin-left:36pt;padding-left:0pt}.c0{padding:0;margin:0}.c22{color:inherit;text-decoration:inherit}.c16{margin-left:108pt;padding-left:0pt}.c21{margin-left:72pt;padding-left:0pt}.c14{font-weight:400;font-family:"Courier New"}.c17{font-weight:700}.c7{height:11pt}.c9{font-style:italic}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c15"><p class="c12"><span class="c24">Magic-Folder discovers new files</span></p><p class="c11 c7"><span class="c5"></span></p><p class="c11"><span class="c17">Contacts:</span><span>&nbsp;</span><span class="c5">meejah</span></p><p class="c11"><span class="c17">Date:</span><span class="c17 c9">&nbsp;</span><span class="c9">2021-06-03</span></p><p class="c11 c7"><span class="c5"></span></p><p class="c11"><span class="c1">When starting up the software, magic-folders should find new or changed files since the last time it ran in every Magic Folder it is tracking.</span></p><h1 class="c18" id="h.nvkn8wdw3jat"><span class="c2">Rationale</span></h1><p class="c11"><span>This is a core function of magic-folders.</span></p><h1 class="c18" id="h.gpxahb23etpo"><span class="c2">User stories</span></h1><p class="c4 c7"><span class="c1"></span></p><h3 class="c23" id="h.snu6v7h6c2p5"><span class="c3">Start magic-folders a Second Time</span></h3><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c1">As a user, I want local filesystem changes to be discovered and uploaded so that the Snapshots in Tahoe represent my local filesystem state</span></p><p class="c4 c7"><span class="c1"></span></p><h3 class="c23" id="h.5rg5ytaytt2e"><span class="c3">Discover the State of Synchronization</span></h3><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span>As a user, I wish to know whether magic-folders has currently queued more work to do and how long ago it was since it checked for more work to do.</span></p><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c9">Keeping the story template here in case we want to add more</span></p><h3 class="c10" id="h.5rdns1qpwxzt"><span class="c3">$STORY_NAME</span></h3><p class="c11 c7"><span class="c3"></span></p><p class="c11"><span class="c1">As a $PERSON, I want $FEATURE so that $BENEFIT.</span></p><p class="c11 c7"><span class="c1"></span></p><p class="c11"><span class="c5">Have as many as you like. Group user stories together into meaningfully deliverable units.</span></p><h1 class="c18" id="h.h5012lkkieog"><span class="c2">Constraints and requirements</span></h1><h2 class="c13" id="h.of9674t19w5m"><span class="c6">Must</span></h2><ul class="c0 lst-kix_84lnh7u5mxb7-0 start"><li class="c11 c8 li-bullet-0"><span>New </span><span>files</span><span class="c1">&nbsp;are discovered (a &ldquo;new file&rdquo; is one that wasn&rsquo;t present when magic-folders was last turned off). Note that this includes files in sub-directories (recursively) below our Magic Folder.</span></li><li class="c11 c8 li-bullet-0"><span class="c1">Local files that are different from the Tahoe representation are discovered</span></li><li class="c11 c8 li-bullet-0"><span>Deleted files are discovered (a &ldquo;deleted file&rdquo; is one that was present when magic-folders was last turned off but is no longer present).</span></li></ul><h2 class="c13" id="h.d95ublyequtl"><span class="c6">Nice to have</span></h2><h2 class="c13" id="h.a7u3o1773qf1"><span class="c6">Must not</span></h2><ul class="c0 lst-kix_psdl1h1cd5l7-0 start"><li class="c11 c8 li-bullet-0"><span>Files that are not changed should not be re-uploaded (a &ldquo;not changed&rdquo; file is one that was present when magic-folders was last turned off and is still present with the same bytes as content)</span></li></ul><h2 class="c13" id="h.7uwekdzc687e"><span class="c6">Out of scope</span></h2><p class="c11"><span class="c5">Things that are definitely not included that people ask about.</span></p><h1 class="c18" id="h.malwuxqsfc4"><span class="c2">Success</span></h1><h2 class="c13" id="h.lm3s8x4bu8vy"><span class="c6">How will we know when we are done?</span></h2><p class="c4"><span class="c1">The state of our Personal DMD in Tahoe should match the state of our local filesystem at some point after we re-start the magic-folders software. &ldquo;Match the state&rdquo; here means:</span></p><ul class="c0 lst-kix_knv9hvmv5v30-0 start"><li class="c4 c8 li-bullet-0"><span class="c1">Any file present below our Magic Folder has a Snapshot present in Tahoe</span></li><li class="c4 c8 li-bullet-0"><span class="c1">The &ldquo;content&rdquo; subdir of that Snapshot points at an immutable capability that matches the bytes we have on disk</span></li><li class="c4 c8 li-bullet-0"><span class="c1">Any file that used to be present but no longer exists locally should have an empty / missing &ldquo;content&rdquo; subdir in its Snapshot on Tahoe (that is, there will still be an entry in Tahoe but it will indicate that the corresponding local file is deleted).</span></li></ul><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c1">There is some vagueness above about knowing when the synchronization is completed. It should be possible to use the status API to discover if magic-folders has work queued. The above checks should be valid after:</span></p><ul class="c0 lst-kix_oejw0yw2lfsb-0 start"><li class="c4 c8 li-bullet-0"><span class="c1">Magic-folders has started up successfully</span></li><li class="c4 c8 li-bullet-0"><span>The status-API indicates there is no (upload) work in progress (</span><span class="c14 c19">synchronizing=false)</span></li><li class="c4 c8 li-bullet-0"><span>The status-API indicates a &ldquo;last-scan&rdquo; time completed </span><span class="c9">after</span><span>&nbsp;the time when magic-folders was re-started.</span></li></ul><h2 class="c13" id="h.n5min1g7jjg2"><span class="c6">How will we measure how well we have done?</span></h2><p class="c11 c7"><span class="c6"></span></p><p class="c11"><span class="c5">It might be a good idea to stop at this point &amp; get feedback, to make sure you&rsquo;re solving the right problem.</span></p><h1 class="c18" id="h.l9deb8szxlfn"><span class="c2">Alternatives considered</span></h1><ul class="c0 lst-kix_i55sx8bc07u6-0 start"><li class="c11 c8 li-bullet-0"><span>Watchman (</span><span class="c20"><a class="c22" href="https://www.google.com/url?q=https://facebook.github.io/watchman/&amp;sa=D&amp;source=editors&amp;ust=1623432409430000&amp;usg=AOvVaw27El8sD-DrOc8lgUX8UdNH">https://facebook.github.io/watchman/</a></span><span>). A client/server c++ daemon. Monitors the filesystem (using native APIs like inotify) and supports queries etc via a client CLI or API.</span></li></ul><h1 class="c18" id="h.vbd35v6xbjg1"><span class="c2">Detailed design</span></h1><p class="c4"><span class="c1">When triggered, the scanning system walks the entire tree of files below the Magic Folder.</span></p><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span>As we use </span><span class="c14">twisted.python.filepath.FilePath</span><span>&nbsp;for many other operations within magic-folder we will use </span><span class="c14">FilePath.walk()</span><span class="c1">&nbsp;to traverse the files. This produces a generator; we should take care to yield control back to the reactor occasionally so that we don&rsquo;t starve network reads/writes if we are descending a lot of files.</span></p><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c1">For each file found:</span></p><ul class="c0 lst-kix_ntqubcj0j1hx-0 start"><li class="c4 c8 li-bullet-0"><span class="c1">Mangle / flatten the name to a Snapshot name</span></li><li class="c4 c8 li-bullet-0"><span class="c1">Check if we already have a Snapshot for this name:</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-1 start"><li class="c4 c21 li-bullet-0"><span class="c1">As a LocalSnapshot</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-2 start"><li class="c4 c16 li-bullet-0"><span class="c1">We can compare directly the stashed contents to the file contents</span></li><li class="c4 c16 li-bullet-0"><span class="c1">If different, produce a new LocalSnapshot as a child of this one</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-1"><li class="c4 c21 li-bullet-0"><span class="c1">..or a RemoteSnashot</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-2 start"><li class="c4 c16 li-bullet-0"><span class="c1">Compare the file contents to the Snapshot:</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-3 start"><li class="c4 c25 li-bullet-0"><span class="c1">include st_mtime in the remotesnapshot table (or a new table) representing the modification time of the local file when we last uploaded (or downloaded) this Snapshot.</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-2"><li class="c4 c16 li-bullet-0"><span class="c1">If the st_mtime is different, produce a new LocalSnapshot as a child of the RemoteSnapshot</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-1"><li class="c4 c21 li-bullet-0"><span class="c1">..or no snapshots at all yet</span></li></ul><ul class="c0 lst-kix_ntqubcj0j1hx-2 start"><li class="c4 c16 li-bullet-0"><span>Create a new LocalSnapshot with no parent</span></li></ul><h2 class="c13" id="h.tpkqgpuu5fpi"><span class="c6">Data integrity</span></h2><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c1">Do not do overlapping scans. There should be either zero or one scans happening at any given time for any given Magic Folder.</span></p><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c1">Consider the uploader: it may be turning LocalSnapshots into RemoteSnapshots at the moment.</span></p><ul class="c0 lst-kix_rl6vdisu7lga-0 start"><li class="c4 c8 li-bullet-0"><span>If LocalSnapshots for a given file are currently being uploaded there is a window between when they were deserialized but before the local data is deleted when a newly added LocalSnapshot will be dropped (see the ticket for this though: </span><span class="c20"><a class="c22" href="https://www.google.com/url?q=https://github.com/LeastAuthority/magic-folder/issues/385&amp;sa=D&amp;source=editors&amp;ust=1623432409434000&amp;usg=AOvVaw3w4LFq95i0fKn2LbMUU5h5">https://github.com/LeastAuthority/magic-folder/issues/385</a></span><span class="c1">&nbsp;). Fixing that ticket should handle this problem.</span></li></ul><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c1">Consider the downloader: it may be discovering new RemoteSnapshots and downloading them.</span></p><ul class="c0 lst-kix_h2evnjn3q36j-0 start"><li class="c4 c8 li-bullet-0"><span class="c1">Is there any point where the scanner may be confused by a newly-appearing file from the downloader and falsely believe it should upload it?</span></li></ul><ul class="c0 lst-kix_h2evnjn3q36j-1 start"><li class="c4 c21 li-bullet-0"><span class="c1">The file is first downloaded to a stash area and then moved into place. So I think the scanner will only see the updated file (along with the corresponding st_mtime in the database) or not. Both cases should result in no change detected.</span></li></ul><p class="c4 c7"><span class="c1"></span></p><p class="c4"><span class="c1">Consider the user: they may be changing or adding files at any moment (e.g. during the scan).</span></p><ul class="c0 lst-kix_2kvjyg2pkx3g-0 start"><li class="c4 c8 li-bullet-0"><span class="c1">I think the only possible consequence here is that a file is discovered later than it might otherwise be. E.g. the user makes a new file appear in a directory we already walked</span></li><li class="c4 c8 li-bullet-0"><span>The old magic-folder did take some pains to consider the case where a user is actively editing a file or otherwise making rapid changes. However, this was using inotify too so changes were discovered more rapidly (e.g. on file creation and save). I don&rsquo;t see a compelling case to duplicate any such logic here.</span></li></ul><h2 class="c13" id="h.5h8b0wo26qwb"><span class="c6">Security</span></h2><p class="c4"><span>We must not &ldquo;discover&rdquo; a file outside the magic-folder directory.</span></p><h2 class="c13" id="h.2gktxt6985c"><span class="c6">Backwards compatibility</span></h2><p class="c4"><span>None.</span></p><h2 class="c13" id="h.w1xp6y91ksy3"><span class="c6">Performance and scalability</span></h2><p class="c4"><span>When scanning a large directory we must take care not to pause the reactor for &ldquo;too long&rdquo;</span></p><h1 class="c18" id="h.a2la8hdasxg"><span class="c2">Further reading</span></h1><p class="c11"><span class="c5">Links to related things. Other designs, tickets, epics, mailing list threads, etc.</span></p><p class="c4 c7"><span class="c1"></span></p></body></html>