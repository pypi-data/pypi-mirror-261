<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Downloader Operation &mdash; Magic-Folder 1.x documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=05353d0c" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=16df9e97"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Magic-Folder Release Process" href="release-process.html" />
    <link rel="prev" title="Magic Folder Data Model" href="datamodel.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Magic-Folder
          </a>
              <div class="version">
                1.x
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using Magic Folder</a></li>
<li class="toctree-l1"><a class="reference internal" href="invites.html">How invites work</a></li>
<li class="toctree-l1"><a class="reference internal" href="limitations.html">Known Issues and Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases of Magic Folder</a></li>
<li class="toctree-l1"><a class="reference internal" href="backdoors.html">Statement on Backdoors</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Magic-Folder Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface.html">Local HTTP Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="snapshots.html">Snapshots Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="datamodel.html">Magic Folder Data Model</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Downloader Operation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general-operation">General Operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-snapshots-to-download">What Snapshots to Download</a></li>
<li class="toctree-l2"><a class="reference internal" href="#downloading-snapshots">Downloading Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="#on-overwrite">On Overwrite</a></li>
<li class="toctree-l2"><a class="reference internal" href="#on-conflict">On Conflict</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="release-process.html">Magic-Folder Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-process.html#making-a-release">Making a Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="leif-design.html">The Leif Design: synchronization model</a></li>
<li class="toctree-l1"><a class="reference internal" href="proposed/index.html">Proposed Specifications</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Magic-Folder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Downloader Operation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/downloader.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="downloader-operation">
<span id="downloader"></span><h1>Downloader Operation<a class="headerlink" href="#downloader-operation" title="Link to this heading"></a></h1>
<p>Audience: developers working on magic-folder itself</p>
<p><strong>Note:</strong> some of this document describes features that aren’t yet implemented; those are noted with (Not implemented).</p>
<p>This describes the general operation of the remote to local synchronization.
The overall design was first articulated in “the Leif Design” (see <span class="xref std std-ref">Leif’s Proposal: Magic-Folder “single-file” snapshot design</span>).</p>
<p>We do not describe the synchronization of the list of participants in a magic-folder.
This list will consist of at least:</p>
<ul class="simple">
<li><p>an arbitrary <code class="docutils literal notranslate"><span class="pre">name</span></code> for each participant</p></li>
<li><p>a directory read-capability for each participant (“Personal DMD”)</p></li>
<li><p>in this directory is a flattened representation of every file in  the Magic Folder (similar to the Tahoe 1.14.0 design) with each entry pointing to a Snapshot.
That is, there are no sub-directories to recurse into: all files are listed by downloading just the “personal DMD” capability of that participant.</p></li>
</ul>
<p>“A Snapshot” is a single version of a single file.
It is represented by an immutable directory and contains:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">content</span></code>: (optional) a read-only Capability to the actual content of this Snapshot.
Deletion Snapshots contain no such key.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metadata</span></code>: information about the Snapshot, a read-only Capability pointing to a JSON-serialized dict containing:
- <code class="docutils literal notranslate"><span class="pre">snapshot_version</span></code>: int(1) currently
- <code class="docutils literal notranslate"><span class="pre">name</span></code>: the name of this snapshot (a relative path)
- <code class="docutils literal notranslate"><span class="pre">author</span></code>: a dict containing:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: arbitrary name</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verify_key</span></code>: base64-encoded public key of the author</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">parents</span></code>: a list of immutable Capability-strings of any parent Snapshots</p></li>
<li><p>(not yet) additionally, in the Tahoe metadata for this metadata-capability is a <code class="docutils literal notranslate"><span class="pre">magic_folder</span></code> dict with the following keys:
- <code class="docutils literal notranslate"><span class="pre">author_signature</span></code>: base64-encoded signature which signs the content-Capability, metadata-Capability and name</p></li>
</ul>
</li>
</ul>
<p>If there are zero parents this is the first version of a file.
If there is one parent it is a modification.
If there are two or more parents this version is the resolution of a conflict.</p>
<p>When reading the code, there is a method <code class="docutils literal notranslate"><span class="pre">create_snapshot_from_capability</span></code> which downloads a capability-string from Tahoe and returns a <code class="docutils literal notranslate"><span class="pre">RemoteSnapshot</span></code> instance.</p>
<section id="general-operation">
<h2>General Operation<a class="headerlink" href="#general-operation" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">DownloaderService</span></code> is responsible for deciding which Snapshots to download.
The capability strings of Snapshots to download are given to <code class="docutils literal notranslate"><span class="pre">RemoteSnapshotCacheService</span></code> which downloads a Snapshot and all its relevant parents into memory.
Once a Snapshot is downloaded it is passed to the <code class="docutils literal notranslate"><span class="pre">MagicFolderUpdaterService</span></code> which stages the actual content and determins if the change is an “overwrite” or a “conflict” and changes the local filesystem accordingly.</p>
<p>Downloading new Snapshots from other participants ultimately causes changes to the local filesystem (in the magic-folder).</p>
<p>(Not implemented). It may be the case that one or more parent Snapshots are missing.
In this case, we cannot cache or otherwise see those Snapshots and must take local action accordingly; see the section on conflicts for more.</p>
</section>
<section id="what-snapshots-to-download">
<h2>What Snapshots to Download<a class="headerlink" href="#what-snapshots-to-download" title="Link to this heading"></a></h2>
<p>Each configured magic-folder has a <code class="docutils literal notranslate"><span class="pre">collective_dircap</span></code> which is a Tahoe-LAFS Directory Capability (“dircap”) for the list of participants.
If this dircap is writable then this device is the administrator (and the only device which can modify the participants).</p>
<p>In either case, the capability can be downloaded.
It will be a Tahoe-LAFS directory containing a series of sub-directories; these are the participants.
The directory name is the Participant name and points at a directory read-capability where all the files in their magic-folder are stored.
This directory is known as the “Personal DMD” (where DMD stands for “Distributed Mutable Directory”).</p>
<p>The entries in a user’s Personal DMD are flat (no subdirectories) and point a (mangled) relative path-name to a Snapshot.</p>
<p>So, Snapshots to download are discovered by:</p>
<ul>
<li><p>reading the Collective DMD</p></li>
<li><p>for each user in it:
- read their Personal DMD
- for each entry in the Personal DMD:</p>
<blockquote>
<div><ul class="simple">
<li><p>queue the Snapshot for caching, including all parents (see note)</p></li>
<li><p>after download, queue the Snapshot for updates</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>Note that we don’t always download <em>every</em> parent; we stop early if a common ancestor is found (see below).</p>
</section>
<section id="downloading-snapshots">
<h2>Downloading Snapshots<a class="headerlink" href="#downloading-snapshots" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">RemoteSnapshotCacheService</span></code> awaits capability-strings of Snapshots to download.
For each one, the function <code class="docutils literal notranslate"><span class="pre">create_snapshot_from_capability</span></code> is used to download the capability and return a <code class="docutils literal notranslate"><span class="pre">RemoteSnapshot</span></code> instance.
This <code class="docutils literal notranslate"><span class="pre">RemoteSnapshot</span></code> is stored in memory.</p>
<p>Additionally, all parents of the Snapshot are also cached.
We can stop caching parents once we find a “common ancestor”; this means a parent in the remote snapshot that matches the one in our Personal DMD.</p>
<p>Conflict Resolution is described in <span class="xref std std-ref">Multi-party Conflict Detection</span> under the Leif’s Design section.
Briefly: a <code class="docutils literal notranslate"><span class="pre">RemoteSnapshot</span></code> is traced through its parents until a common ancestor is found.
If the new Snapshot is a descendant of our latest Snapshot for that name, it’s an overwrite.
If it is not, there is a conflict (unless we don’t yet have that name at all, then it’s a creation).
(Not implemented). If we cannot traverse all parents due to missing Snapshots and have still failed to find a common ancestor we must assume it is a conflict.
(Not implemented). If there is a local file “in the way” for which no <code class="docutils literal notranslate"><span class="pre">LocalSnapshot</span></code> already exists it is also a conflict.</p>
</section>
<section id="on-overwrite">
<h2>On Overwrite<a class="headerlink" href="#on-overwrite" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">content</span></code> of the <code class="docutils literal notranslate"><span class="pre">RemoteSnapshot</span></code> is downloaded and moved into place in our Magic Folder.
The local <code class="docutils literal notranslate"><span class="pre">remotesnapshot</span></code> database table is updated to point at our new <code class="docutils literal notranslate"><span class="pre">RemoteSnapshot</span></code>.
Our Personal DMD is updated to point at this Snapshot.</p>
<p>In case there is no <code class="docutils literal notranslate"><span class="pre">content</span></code> this is a delete and we simply remove the corresponding local file.</p>
<p>Note that a completely new file (a “create”) is the same as a normal overwrite (except of course there’s no possibility of a conflict).</p>
</section>
<section id="on-conflict">
<h2>On Conflict<a class="headerlink" href="#on-conflict" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">content</span></code> of the <code class="docutils literal notranslate"><span class="pre">RemoteSnapshot</span></code> is downloaded and moved into a “conflict file” (see Leif Design) beside the conflicting content.
The Personal DMD is <strong>not</strong> updated.
(Not implemented). Once the conflict is “resolved” then a new Snapshot is created with two parents: the latest Snapshot we had at conflict time and the conflicting Snapshot.
Our Personal DMD is updated to point at this new Snapshot.</p>
<p>(Not implemented). “Resolving” a snapshot will be noticed via more filesystem manipulation: the <code class="docutils literal notranslate"><span class="pre">.confict</span></code> file is deleted or moved (and the existing file is taken to be the new content).
For example, deciding “I like the other device’s file better” would mean moving the <code class="docutils literal notranslate"><span class="pre">.conflict</span></code> file over top of the existing one.
Deciding “I like mine better” means simply deleting the <code class="docutils literal notranslate"><span class="pre">.conflict</span></code> file.
A more-complex strategy of merging the contents would mean updating the existing file <strong>before</strong> deleting the <code class="docutils literal notranslate"><span class="pre">.conflict</span></code> file.</p>
<p>(Meejah believes the above accurately describes what Tahoe 1.14.0 magic-folder does).</p>
<p>This doesn’t mean it’s the best “API” for conflict resolution (nor does it need to remain the only one).
In fact, it likely is not a good API for any but motivated, advanced users and also seems like a bad API for other programs.</p>
<p>(Not implemented). In keeping with other new development in magic-folder, there is an explicit HTTP API to resolve a conflict.
For now, we limit this to selecting “mine” or “theirs”.
A future extension might wish to provide a way to provide completely new content (e.g. if the user edited a diff, for example).</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="datamodel.html" class="btn btn-neutral float-left" title="Magic Folder Data Model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="release-process.html" class="btn btn-neutral float-right" title="Magic-Folder Release Process" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The Tahoe-LAFS Developers, The Magic-Folder Developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>