<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuration Storage &mdash; Magic-Folder 1.x documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=05353d0c" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=16df9e97"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Snapshots Design" href="snapshots.html" />
    <link rel="prev" title="Local HTTP Interface" href="interface.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Magic-Folder
          </a>
              <div class="version">
                1.x
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using Magic Folder</a></li>
<li class="toctree-l1"><a class="reference internal" href="invites.html">How invites work</a></li>
<li class="toctree-l1"><a class="reference internal" href="limitations.html">Known Issues and Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases of Magic Folder</a></li>
<li class="toctree-l1"><a class="reference internal" href="backdoors.html">Statement on Backdoors</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Magic-Folder Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface.html">Local HTTP Interface</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configuration Storage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#context-and-history">Context and History</a></li>
<li class="toctree-l2"><a class="reference internal" href="#legacy-configuration-and-state">Legacy Configuration and State</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-needs-to-be-stored">What Needs to be Stored</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ui-to-change-the-config">UI to Change the Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="#where-and-how-to-store-the-configuration">Where and How To Store the Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="snapshots.html">Snapshots Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="datamodel.html">Magic Folder Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="downloader.html">Downloader Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-process.html">Magic-Folder Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-process.html#making-a-release">Making a Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="leif-design.html">The Leif Design: synchronization model</a></li>
<li class="toctree-l1"><a class="reference internal" href="proposed/index.html">Proposed Specifications</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Magic-Folder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Configuration Storage</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/config.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="configuration-storage">
<span id="config"></span><h1>Configuration Storage<a class="headerlink" href="#configuration-storage" title="Link to this heading"></a></h1>
<p>If you are looking for the description of the current
configuration-storage mechanisms, skip down to <a class="reference internal" href="#current"><span class="std std-ref">the current
storage description</span></a>.</p>
<section id="context-and-history">
<h2>Context and History<a class="headerlink" href="#context-and-history" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">magic-folder</span></code> originally was extracted from Tahoe-LAFs where it was a
sub-command / sub-system. Thus, it inherited Tahoe’s method of
configuration. This is a menagerie of various files in a “node
directory” including a <code class="docutils literal notranslate"><span class="pre">tahoe.cfg</span></code> INI-style file. There is a
<code class="docutils literal notranslate"><span class="pre">private/</span></code> sub-directory which often has “extra-private” information
(like secret keys).</p>
<p>Although a magic-folder is necessarily tied to a Tahoe-LAFS client we
don’t <em>need</em> to store our configuration there.</p>
<p>We have decided that a user upgrading from a <code class="docutils literal notranslate"><span class="pre">tahoe</span> <span class="pre">magic-folder</span></code>
style Magic Folder to a stand-alone Magic Folder will run
<code class="docutils literal notranslate"><span class="pre">magic-folder</span> <span class="pre">migrate</span></code>. This allows us the freedom to store our
configuration in any way we like.</p>
</section>
<section id="legacy-configuration-and-state">
<h2>Legacy Configuration and State<a class="headerlink" href="#legacy-configuration-and-state" title="Link to this heading"></a></h2>
<p>In versions of Tahoe-LAFS that had magic-folder enabled, the following
configuration could be used:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enabled</span></code> (bool) from <code class="docutils literal notranslate"><span class="pre">tahoe.cfg</span> <span class="pre">[magic_folder]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">local.directory</span></code> (from <code class="docutils literal notranslate"><span class="pre">tahoe.cfg</span> <span class="pre">[magic_folder]</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">poll_interval</span></code> (from <code class="docutils literal notranslate"><span class="pre">tahoe.cfg</span> <span class="pre">[magic_folder]</span></code>)</p></li>
<li><p>“magic folders” dict from
<code class="docutils literal notranslate"><span class="pre">&lt;node_dir&gt;/private/magic_folders.yaml</span></code>. This uses magic-folder
“names” as keys with the following valid keys as sub-dicts:
- <code class="docutils literal notranslate"><span class="pre">directory</span></code>: local path to the “magic folder”
- <code class="docutils literal notranslate"><span class="pre">poll_interval</span></code>: how often to poll (in seconds)
- <code class="docutils literal notranslate"><span class="pre">collective_dircap</span></code>: read-cap of the shared directory (list of users)
- <code class="docutils literal notranslate"><span class="pre">upload_dircap</span></code>: write-cap of our mutable directory
- <code class="docutils literal notranslate"><span class="pre">umask</span></code>: the umask to use for downloaded files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;node_dir&gt;/private/magicfolder_&lt;name&gt;.sqlite</span></code> the local sqlite
database for tracking state</p></li>
</ul>
<p>Related, Tahoe-LAFS has a token in <code class="docutils literal notranslate"><span class="pre">&lt;node_dir&gt;/private/api_auth_token</span></code>
which is required to access parts of the Web API. This isn’t directly
part of magic-folder’s configuration (however, standalone magic-folder
will also use such a token).</p>
</section>
<section id="what-needs-to-be-stored">
<h2>What Needs to be Stored<a class="headerlink" href="#what-needs-to-be-stored" title="Link to this heading"></a></h2>
<p>As we are currently re-designing the storage mechanism, some of this
might change. However, based on current understanding the state we
WANT to store is:</p>
<ul>
<li><p>for each magic-folder (indexed by “name”):
- local directory path (the “magic folder”)
- an author:</p>
<blockquote>
<div><ul class="simple">
<li><p>name</p></li>
<li><p>private_key (32 bytes, a NaCl signing key)</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>a write-cap of our mutable directory</p></li>
<li><p>some state (see below)</p></li>
</ul>
</li>
<li><p>the node-directory of our Tahoe-LAFS client
- we may need the <code class="docutils literal notranslate"><span class="pre">private/api_auth_token</span></code>
- we will need the <code class="docutils literal notranslate"><span class="pre">node.url</span></code> (at least)
- (it MAY be sufficient to only store the API endpoint (the contents</p>
<blockquote>
<div><p>of <code class="docutils literal notranslate"><span class="pre">node.url</span></code>), not node-directory. If it’s feasible to only store
the API endpoint, we should do that instead of caring about the
node-directory. It would probably still be convenient to refer to
a Tahoe client by node-directory (but we can just pull out the
Web-API endpoint). If we only store the endpoint and the Tahoe
config changes, the user would also have to change their
magic-folder config.</p>
</div></blockquote>
</li>
<li><p>our own API endpoint (a Twisted server endpoint-string,
e.g. <code class="docutils literal notranslate"><span class="pre">tcp:1234</span></code> or <code class="docutils literal notranslate"><span class="pre">unix:/tmp/foo</span></code>)</p></li>
</ul>
<p>State that we need to store:</p>
<ul class="simple">
<li><p>a secret token that protects the API (only users who can read the
file can access the endpoint)</p></li>
<li><p>list of other participants (per magic-folder) (see note)</p></li>
<li><p>local cache of remote snapshots (probably per-magic folder)</p></li>
<li><p>local copy of snapshots we haven’t yet uploaded (probably per-magic folder)
- metadata details of the snapshot
- “stash directory” for file-data of the snapshot</p></li>
</ul>
<p>NOTE: Currently the “list of other participants” comes from the
“collective dircap” but in the Leif Design each user decides whom they
wish to pull updates from. So, the “list of other participants” above
might be “a readcap of a directory” (and we would determine the actual
list at runtime by reading that capability).</p>
</section>
<section id="ui-to-change-the-config">
<h2>UI to Change the Config<a class="headerlink" href="#ui-to-change-the-config" title="Link to this heading"></a></h2>
<p>Writing configuration files is hard, error-prone and not a great
interface. It also makes it hard (or impossible) to change where or
how configuration is stored. All configuration shall be changed by an
HTTP API. There will also be CLI commands that are thin wrappers of
the HTTP API. GUI front-ends could use the command-line or the HTTP
API. Nothing except the HTTP API should be touching the actual stored
configuration.</p>
<p>(Of course we can’t stop users from editing the config files
themselves, but this should be discouraged).</p>
</section>
<section id="where-and-how-to-store-the-configuration">
<span id="current"></span><h2>Where and How To Store the Configuration<a class="headerlink" href="#where-and-how-to-store-the-configuration" title="Link to this heading"></a></h2>
<p>Somewhat mirroring Tahoe-LAFS’s design, configuration shall all be
found in a single directory. This directory can be specified via
command-line option. (Should we have a default? Seems sensible, most
OSes have a reasonably well-defined place for programs to store
configuration data).</p>
<p>All global configuration and state shall be stored in an SQLite3
database. This database will have tables for global configuration and
state.</p>
<p>The “configuration directory” will look like this:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">confdir</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">~/.config/magic-folder</span></code>)
- <code class="docutils literal notranslate"><span class="pre">global.sqlite</span></code>
- <code class="docutils literal notranslate"><span class="pre">api_token</span></code>: 32 bytes of binary data
- <code class="docutils literal notranslate"><span class="pre">magic_folder.pid</span></code>: contains the PID of the currently-running process</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">global.sqlite</span></code> database will have the following tables:</p>
<ul>
<li><p>“version” with a single row containing “1”</p></li>
<li><p>“magic_folders”
- columns:
- <code class="docutils literal notranslate"><span class="pre">name</span></code> is a unique unicode string the user provides to identify this folder
- <code class="docutils literal notranslate"><span class="pre">location</span></code> is a local path for that folder’s configuration</p></li>
<li><p>“config”
- columns:
- <code class="docutils literal notranslate"><span class="pre">api_endpoint</span></code> is a Twisted server string description
- <code class="docutils literal notranslate"><span class="pre">tahoe_node_directory</span></code> is the node-directory of our Tahoe-LAFS</p>
<blockquote>
<div><p>client</p>
<p>Note: Ideally, we’d only need the Web-API URI however that can be
configured in tahoe to be randomly-assigned on startup and so we
should read the URI from <code class="docutils literal notranslate"><span class="pre">node.url</span></code>. There may be other
configuration we’ve neglected (since magic-folder used to be
inside Tahoe) so this also allows us to fix that later too.</p>
</div></blockquote>
</li>
</ul>
<p>Each “magic folder” location is a directory containing the
stash-directory and state for that magic-folder. It will look like
this:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;magic</span> <span class="pre">folder</span> <span class="pre">location&gt;/</span></code>
- <code class="docutils literal notranslate"><span class="pre">README</span></code>: a file containing information about magic-folder
- <code class="docutils literal notranslate"><span class="pre">state.sqlite</span></code>: the state database
- <code class="docutils literal notranslate"><span class="pre">api_client_endpoint</span></code>: a Twisted endpoint-string describing how to connect to the HTTP API
- <code class="docutils literal notranslate"><span class="pre">api_token</span></code>: the token required to authenticate to the HTTP API
- <code class="docutils literal notranslate"><span class="pre">folder-&lt;hash&gt;</span></code>: one subdirectory for each magic-folder in the daemon</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stash/</span></code>: the stash-directory containing LocalSnapshot content</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">state.sqlite</span></code>: state database for this magic-folder</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">state.sqlite</span></code> for each magic-folder shall contain the following
tables:</p>
<ul class="simple">
<li><p>“version” (will always contain 1 row)
- column:
- “version” is an int, currently <code class="docutils literal notranslate"><span class="pre">1</span></code></p></li>
<li><p>version-dependent additional tables</p></li>
</ul>
<p>See the SQL statements creating additional tables in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>.
Each version may add or change tables.
The configuration should only be read and changed via the <a href="#id1"><span class="problematic" id="id2">`http-api`_</span></a> and not via this database.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="interface.html" class="btn btn-neutral float-left" title="Local HTTP Interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="snapshots.html" class="btn btn-neutral float-right" title="Snapshots Design" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The Tahoe-LAFS Developers, The Magic-Folder Developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>