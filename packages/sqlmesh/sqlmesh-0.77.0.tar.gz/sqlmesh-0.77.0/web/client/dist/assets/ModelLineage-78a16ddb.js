import{r,R as l,s as z,ar as Ce,d as ie,i as D,j as t,c as _,q as W,B as ce,aA as je,g as de,h as Y,P as ke,V as Ee,aB as Me,L as ue,S as me,z as se,D as Se}from"./index-756a9c57.js";import{d as ze,e as he,s as ge,f as J,P as pe,h as ee,b as O,i as T,j as Le,k as ne,M as Ie,l as Ae,R as Be,m as He,n as Re,o as ae,p as oe,q as re,r as De,t as Te,v as Ue,w as _e}from"./context-f1ba17f3.js";import{a as We}from"./editor-44ea1d6e.js";import{X as Oe,L as $e}from"./ListboxShow-bcacdec5.js";import{S as Ve}from"./SearchList-25a7bbd1.js";import{z as Fe}from"./Input-cad048fe.js";import{w as Q}from"./transition-d4307333.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./file-146d9a8a.js";import"./project-c7710f9a.js";function Pe({title:e,titleId:s,...n},f){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:f,"aria-labelledby":s},n),e?r.createElement("title",{id:s},e):null,r.createElement("path",{fillRule:"evenodd",d:"M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z",clipRule:"evenodd"}))}const Ge=r.forwardRef(Pe),qe=Ge;function Ke(){return l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},l.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function Xe(){return l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},l.createElement("path",{d:"M0 0h32v4.2H0z"}))}function Ze(){return l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},l.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function Qe(){return l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},l.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function Ye(){return l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},l.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const G=({children:e,className:s,...n})=>l.createElement("button",{type:"button",className:ee(["react-flow__controls-button",s]),...n},e);G.displayName="ControlButton";const Je=e=>({isInteractive:e.nodesDraggable||e.nodesConnectable||e.elementsSelectable,minZoomReached:e.transform[2]<=e.minZoom,maxZoomReached:e.transform[2]>=e.maxZoom}),fe=({style:e,showZoom:s=!0,showFitView:n=!0,showInteractive:f=!0,fitViewOptions:o,onZoomIn:a,onZoomOut:x,onFitView:d,onInteractiveChange:b,className:u,children:i,position:v="bottom-left"})=>{const m=ze(),[M,y]=r.useState(!1),{isInteractive:h,minZoomReached:p,maxZoomReached:c}=he(Je,ge),{zoomIn:N,zoomOut:w,fitView:g}=J();if(r.useEffect(()=>{y(!0)},[]),!M)return null;const j=()=>{N(),a==null||a()},k=()=>{w(),x==null||x()},S=()=>{g(o),d==null||d()},C=()=>{m.setState({nodesDraggable:!h,nodesConnectable:!h,elementsSelectable:!h}),b==null||b(!h)};return l.createElement(pe,{className:ee(["react-flow__controls",u]),position:v,style:e,"data-testid":"rf__controls"},s&&l.createElement(l.Fragment,null,l.createElement(G,{onClick:j,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:c},l.createElement(Ke,null)),l.createElement(G,{onClick:k,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:p},l.createElement(Xe,null))),n&&l.createElement(G,{className:"react-flow__controls-fitview",onClick:S,title:"fit view","aria-label":"fit view"},l.createElement(Ze,null)),f&&l.createElement(G,{className:"react-flow__controls-interactive",onClick:C,title:"toggle interactivity","aria-label":"toggle interactivity"},h?l.createElement(Ye,null):l.createElement(Qe,null)),i)};fe.displayName="Controls";var et=r.memo(fe),I;(function(e){e.Lines="lines",e.Dots="dots",e.Cross="cross"})(I||(I={}));function tt({color:e,dimensions:s,lineWidth:n}){return l.createElement("path",{stroke:e,strokeWidth:n,d:`M${s[0]/2} 0 V${s[1]} M0 ${s[1]/2} H${s[0]}`})}function st({color:e,radius:s}){return l.createElement("circle",{cx:s,cy:s,r:s,fill:e})}const nt={[I.Dots]:"#91919a",[I.Lines]:"#eee",[I.Cross]:"#e2e2e2"},at={[I.Dots]:1,[I.Lines]:1,[I.Cross]:6},ot=e=>({transform:e.transform,patternId:`pattern-${e.rfId}`});function xe({id:e,variant:s=I.Dots,gap:n=20,size:f,lineWidth:o=1,offset:a=2,color:x,style:d,className:b}){const u=r.useRef(null),{transform:i,patternId:v}=he(ot,ge),m=x||nt[s],M=f||at[s],y=s===I.Dots,h=s===I.Cross,p=Array.isArray(n)?n:[n,n],c=[p[0]*i[2]||1,p[1]*i[2]||1],N=M*i[2],w=h?[N,N]:c,g=y?[N/a,N/a]:[w[0]/a,w[1]/a];return l.createElement("svg",{className:ee(["react-flow__background",b]),style:{...d,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:u,"data-testid":"rf__background"},l.createElement("pattern",{id:v+e,x:i[0]%c[0],y:i[1]%c[1],width:c[0],height:c[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${g[0]},-${g[1]})`},y?l.createElement(st,{color:m,radius:N/a}):l.createElement(tt,{dimensions:w,color:m,lineWidth:o})),l.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${v+e})`}))}xe.displayName="Background";var rt=r.memo(xe);const K={UNKNOWN:"UNKNOWN",STRUCT:"STRUCT"};function lt({id:e,data:s,sourcePosition:n,targetPosition:f}){const o=s??{},{connections:a,models:x,handleClickModel:d,lineage:b,lineageCache:u,selectedNodes:i,setSelectedNodes:v,mainNode:m,withConnected:M,connectedNodes:y,highlightedNodes:h,activeNodes:p}=O(),c=r.useMemo(()=>{var te;const A=x.get(e),R=(A==null?void 0:A.columns)??[];return Object.keys(((te=b[e])==null?void 0:te.columns)??{}).forEach(F=>{const P=R.find(({name:ye})=>ye===decodeURI(F));z(P)&&R.push({name:F,type:K.UNKNOWN})}),R.forEach(F=>{let P=F.type??K.UNKNOWN;P.startsWith(K.STRUCT)&&(P=K.STRUCT),F.type=P}),R},[e,x,b]),N=r.useMemo(()=>Object.values(h).flat(),[h]),[w,g]=r.useState(!1),j=r.useCallback(A=>{A.stopPropagation(),d==null||d(e)},[d,e,s.isInteractive]),k=r.useCallback(A=>{A.stopPropagation(),!(N.includes(e)||m===e)&&v(R=>(R.has(e)?R.delete(e):R.add(e),new Set(R)))},[v,N]),S=h["*"],C=c.some(({name:A})=>a.get(Ce(e,A))),E=Object.keys(h).length>0,q=Object.keys(h).find(A=>h[A].includes(e)),$=m===e,L=N.includes(e),B=i.has(e),V=o.type===T.sql,U=o.type===T.cte,H=o.type===T.external,we=o.type===T.seed,X=o.type===T.unknown,Z=(C||o.withColumns||w||B||$)&&ie(c)&&D(E),be=i.size>0||p.size>0||M?B||p.has(e)||M&&y.has(e):y.has(e),Ne=m!==e&&W(d)&&D(U)&&D(X),ve=D(V);return t.jsxs("div",{onMouseEnter:()=>g(!0),onMouseLeave:()=>g(!1),className:_("text-xs font-semibold border-4",w?"z-50":"z-1",Z?"rounded-xl":"rounded-2xl",(E?L:be)||$?"opacity-100":"opacity-40 hover:opacity-100",z(q)?E?S:[U?"border-accent-500 bg-accent-500 text-accent-500 dark:border-accent-300 dark:bg-accent-300 dark:text-accent-300":X?"border-neutral-500 bg-neutral-500 text-neutral-500 dark:border-neutral-300 dark:bg-neutral-300 dark:text-neutral-300":"border-secondary-500 bg-secondary-500 text-secondary-500 dark:bg-primary-500  dark:border-primary-500 dark:text-primary-500",$?"ring-8 ring-brand-50":H||we?"ring-8 ring-accent-50":""]:q,B&&U?"ring-8 ring-accent-50":B&&X?"ring-8 ring-neutral-50":B&&"ring-8 ring-secondary-50 dark:ring-primary-50"),style:{maxWidth:z(o.width)?"auto":`${o.width}px`},children:[t.jsx(Le,{id:e,type:o.type,label:o.label,isSelected:B,isDraggable:!0,className:_("bg-theme-lighter",Z?"rounded-t-[8px]":"rounded-xl"),hasLeft:f===ne.Left&&z(u),hasRight:n===ne.Right&&z(u),handleClick:Ne?j:void 0,handleSelect:m===e||U||E||W(u)?void 0:k,count:E?void 0:c.length}),Z&&t.jsx(Ie,{className:"max-h-[15rem] rounded-b-lg",nodeId:e,columns:c,disabled:ve,withHandles:!0,withSource:!0,withDescription:!1})]})}function it({handleSelect:e}){const{models:s,lineage:n,mainNode:f,connectedNodes:o}=O(),[a,x]=r.useState(!1),[d,b]=r.useState([]),[u,i]=r.useState(!1);r.useEffect(()=>{b([])},[f,s,n]);function v(){x(!0)}function m(){x(!1)}function M(y){y.length<1||ie(d)||z(f)||z(n)||(i(!0),setTimeout(()=>{const h=Array.from(Ae(n,f));b(Object.keys(n).map(p=>{var c;return{name:p,displayName:((c=s.get(p))==null?void 0:c.displayName)??decodeURI(p),description:`${h.includes(p)?"Upstream":"Downstream"} | ${o.has(p)?"Directly":"Indirectly"} Connected`}})),i(!1)},300))}return t.jsxs("div",{className:_("w-full",a?"block absolute top-0 left-0 right-0 z-10 pr-10 bg-light dark:bg-dark @[40rem]:items-end @[40rem]:justify-end @[40rem]:flex @[40rem]:static @[40rem]:pr-0":"items-end justify-end flex"),children:[t.jsx(ce,{shape:je.Circle,className:_("flex @[40rem]:hidden !py-1 border-transparent",a?"hidden":"flex"),variant:de.Alternative,size:Y.sm,"aria-label":"Show search",onClick:v,children:t.jsx(qe,{className:"w-3 h-3 text-primary-500"})}),t.jsx(Ve,{list:d,placeholder:"Find",searchBy:"displayName",displayBy:"displayName",direction:"top",descriptionBy:"description",showIndex:!1,size:Y.sm,onSelect:e,isLoading:u,className:_("w-full @sm:min-w-[12rem] @[40rem]:flex",a?"flex max-w-none":"hidden max-w-[20rem]"),isFullWidth:!0,onInput:M}),t.jsx("button",{className:_("flex @[40rem]:hidden bg-none border-none px-2 py-1 absolute right-0 top-0",a?"flex":"hidden"),"aria-label":"Hide search",onClick:m,children:t.jsx(Oe,{className:"w-6 h-6 text-primary-500"})})]})}function le({nodes:e=[]}){const{setCenter:s}=J(),{activeNodes:n,models:f,mainNode:o,nodesMap:a,selectedNodes:x,setSelectedNodes:d,withImpacted:b,connectedNodes:u,lineageCache:i,setActiveEdges:v,setConnections:m,setLineage:M,setLineageCache:y}=O(),h=z(o)?void 0:f.get(o),p=n.size>0?n.size:u.size,c=x.size,N=u.size-1,w=e.filter(C=>C.hidden).length,g=e.filter(C=>D(C.hidden)&&(C.data.type===T.external||C.data.type===T.seed)).length,j=e.filter(C=>D(C.hidden)&&C.data.type===T.cte).length,k=p>0&&p!==N+1;function S(){if(z(o))return;const C=a[o];z(C)||setTimeout(()=>{s(C.position.x,C.position.y,{zoom:.5,duration:0})},200)}return t.jsxs(t.Fragment,{children:[W(h)&&t.jsx("a",{className:"mr-2 w-full whitespace-nowrap text-ellipsis overflow-hidden @lg:block font-bold text-neutral-600 dark:text-neutral-400 cursor-pointer hover:underline",onClick:S,children:ke(h.displayName,50,25)}),t.jsxs("span",{className:"bg-neutral-5 px-2 py-0.5 flex rounded-full mr-2",children:[t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"All:"})," ",e.length]}),w>0&&t.jsxs("span",{className:"whitespace-nowrap block mr-2",children:[t.jsx("b",{children:"Hidden:"})," ",w]}),c>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Selected:"})," ",c]}),k&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Active:"})," ",p]}),(k||c>0||W(i))&&t.jsx(ce,{size:Y.xs,variant:de.Neutral,format:Ee.Ghost,className:"!m-0 px-1",onClick:()=>{v(new Map),m(new Map),d(new Set),W(i)&&(M(i),y(void 0))},children:"Reset"})]}),g>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Sources"}),": ",g]}),D(k)&&b&&c===0&&N>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Upstream/Downstream:"})," ",N]}),j>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"CTEs:"})," ",j]})]})}const ct=30;function yt({model:e,highlightedNodes:s}){const{setActiveEdges:n,setConnections:f,setLineage:o,handleError:a,setSelectedNodes:x,setMainNode:d,setWithColumns:b,setHighlightedNodes:u,setNodeConnections:i,setLineageCache:v,setUnknownModels:m,models:M,unknownModels:y}=O(),{refetch:h,isFetching:p,cancel:c}=Me(e.name),[N,w]=r.useState(!1);r.useEffect(()=>{const j=We();return j.addEventListener("message",g),h().then(({data:k})=>{if(z(k))return;const S=Object.keys(k),C=S.length;S.forEach(E=>{E=encodeURI(E),D(M.has(E))&&D(y.has(E))&&y.add(E)}),m(new Set(y)),C>ct&&b(!1),j.postMessage({topic:"lineage",payload:{currentLineage:{},newLineage:k,mainNode:e.fqn}}),w(!0)}).catch(k=>{a==null||a(k)}).finally(()=>{n(new Map),f(new Map),x(new Set),v(void 0),d(e.fqn)}),()=>{c==null||c(),j.removeEventListener("message",g),j.terminate(),o({}),i({}),d(void 0),u({})}},[e]),r.useEffect(()=>{u(s??{})},[s]);function g(j){j.data.topic==="lineage"&&(w(!1),i(j.data.payload.nodesConnections),o(j.data.payload.lineage)),j.data.topic==="error"&&(a==null||a(j.data.error),w(!1))}return t.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[(p||N)&&t.jsx("div",{className:"absolute top-0 left-0 z-10 w-full h-full bg-theme flex justify-center items-center",children:t.jsxs(ue,{className:"inline-block",children:[t.jsx(me,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md whitespace-nowrap",children:p?"Loading Model's Lineage...":"Merging Model's..."})]})}),t.jsx(Be,{children:t.jsx(dt,{})})]})}function dt(){const{withColumns:e,lineage:s,mainNode:n,selectedEdges:f,selectedNodes:o,withConnected:a,withImpacted:x,withSecondary:d,hasBackground:b,activeEdges:u,connectedNodes:i,connections:v,nodesMap:m,showControls:M,handleError:y,setActiveNodes:h}=O(),{setCenter:p}=J(),[c,N]=r.useState(!1),w=r.useMemo(()=>({model:lt}),[]),g=r.useMemo(()=>He(s),[s]),j=r.useMemo(()=>Re(s),[s]),[k,S]=r.useState([]),[C,E]=r.useState([]);r.useEffect(()=>{if(se(g)||z(n))return;N(!0);const L=ae(g,u,f,m),B=oe(Object.values(m),L,n,i,o,v,a,x,d),V=re(g,v,u,L,f,o,i,a,x,d),U=De({nodesMap:m,nodes:B,edges:V});return U.create().then(H=>{E(H.edges),S(H.nodes)}).catch(H=>{y==null||y(H),E([]),S([])}).finally(()=>{const H=z(n)?void 0:m[n];W(H)&&p(H.position.x,H.position.y,{zoom:.5,duration:0}),setTimeout(()=>{N(!1)},100)}),()=>{U.terminate(),E([]),S([])}},[u,m,j]),r.useEffect(()=>{if(z(n)||se(k))return;const L=ae(g,u,f,m),B=oe(k,L,n,i,o,v,a,x,d),V=re(g,v,u,L,f,o,i,a,x,d);E(V),S(B),h(L)},[v,m,g,u,o,f,i,a,x,d,e,n]);function q(L){S(Ue(L,k))}function $(L){E(_e(L,C))}return t.jsxs(t.Fragment,{children:[c&&t.jsxs("div",{className:"absolute top-0 left-0 z-10 flex justify-center items-center w-full h-full",children:[t.jsx("span",{className:"absolute w-full h-full z-10 bg-transparent-20 backdrop-blur-lg"}),t.jsxs(ue,{className:"inline-block z-10",children:[t.jsx(me,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md whitespace-nowrap",children:"Building Lineage..."})]})]}),t.jsxs(Te,{nodes:k,edges:C,nodeTypes:w,onNodesChange:q,onEdgesChange:$,nodeOrigin:[.5,.5],minZoom:.05,maxZoom:1.5,snapGrid:[16,16],snapToGrid:!0,children:[M&&t.jsxs(pe,{position:"top-right",className:"bg-theme !m-0 w-full !z-10",children:[t.jsx(ut,{nodes:k}),t.jsx(Se,{})]}),t.jsx(et,{className:"bg-light p-1 rounded-md !border-none !shadow-lg"}),t.jsx(rt,{variant:I.Cross,gap:32,size:4,className:_(b?"opacity-100 stroke-neutral-200 dark:stroke-neutral-800":"opacity-0")})]})]})}function ut({nodes:e=[]}){const{withColumns:s,mainNode:n,selectedNodes:f,withConnected:o,withImpacted:a,withSecondary:x,hasBackground:d,activeNodes:b,highlightedNodes:u,setSelectedNodes:i,setWithColumns:v,setWithConnected:m,setWithImpacted:M,setWithSecondary:y,setHasBackground:h}=O(),p=r.useRef(null),c=r.useMemo(()=>Object.values(u??{}).flat(),[u]);function N(w){c.includes(w.name)||n===w.name||i(g=>(g.has(w.name)?g.delete(w.name):g.add(w.name),new Set(g)))}return t.jsxs("div",{className:"px-2 flex items-center text-xs text-neutral-400 @container",children:[t.jsxs("div",{className:"contents",children:[t.jsxs(Q,{className:"flex @lg:hidden bg-none border-none","aria-label":"Show lineage node details",children:[t.jsxs(Q.Button,{ref:p,className:"flex items-center relative w-full cursor-pointer bg-primary-10 text-xs rounded-full text-primary-500 py-1 px-3 text-center focus:outline-none focus-visible:border-accent-500 focus-visible:ring-2 focus-visible:ring-light focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-brand-300 border-1 border-transparent",children:["Details",t.jsx(Fe,{className:"ml-2 h-4 w-4","aria-hidden":"true"})]}),t.jsx(Q.Panel,{className:"absolute left-2 right-2 flex-col z-50 mt-8 transform flex px-4 py-3 bg-theme-lighter shadow-xl focus:ring-2 ring-opacity-5 rounded-lg",children:t.jsx(le,{nodes:e})})]}),t.jsx("div",{className:"hidden @lg:contents w-full",children:t.jsx(le,{nodes:e})})]}),t.jsxs("div",{className:"flex w-full justify-end items-center",children:[t.jsx(it,{handleSelect:N}),t.jsx($e,{options:{Background:h,Columns:b.size>0&&f.size===0?void 0:v,Connected:b.size>0?void 0:m,"Upstream/Downstream":b.size>0?void 0:M,All:b.size>0?void 0:y},value:[s&&"Columns",d&&"Background",o&&"Connected",a&&"Upstream/Downstream",x&&"All"].filter(Boolean)})]})]})}export{yt as default};
