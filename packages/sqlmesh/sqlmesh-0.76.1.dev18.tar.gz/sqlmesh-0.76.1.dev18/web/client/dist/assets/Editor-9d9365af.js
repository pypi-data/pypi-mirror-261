import{r as h,e as ne,j as e,c as x,v as C,w as z,d as Ie,i as M,a as P,k as w,I as G,B as I,h as L,ag as we,F as $,S as X,P as ee,a2 as pe,a3 as Re,a4 as ze,ah as Ne,_ as Ae,u as ye,s as Qe,E as Oe,C as Be}from"./index-71398e80.js";import{u as H,M as We}from"./project-1647c629.js";import{S as ge}from"./SplitPane-7aa47462.js";import{E as W,M as He}from"./file-49f2b60f.js";import{u as g}from"./editor-7738dbd6.js";import{I as v}from"./Input-0c327896.js";import{P as $e}from"./PlusIcon-199e142b.js";import{X as Ge,L as Ve}from"./ListboxShow-097350f3.js";import{B as je}from"./Banner-b2bc813f.js";import{r as D,T as oe}from"./Tab-86c3a5e2.js";import{g as ie,G as Ue,F as Ye,T as qe}from"./help-9ea627b2.js";import{M as Xe,u as Te,a as re,b as Je,c as Ze,C as Ke}from"./context-c9a4c85e.js";import{v as se,M as es,P as ss}from"./disclosure-1c14d4dc.js";import{D as ts}from"./ReportErrors-a3e1b182.js";import"./transition-7cc1de49.js";import"./index-2452699b.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./pluralize-20c4f49a.js";function ls({title:s,titleId:t,...l},a){return h.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:a,"aria-labelledby":t},l),s?h.createElement("title",{id:t},s):null,h.createElement("path",{fillRule:"evenodd",d:"M3 6.75A.75.75 0 013.75 6h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 6.75zM3 12a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zm0 5.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75a.75.75 0 01-.75-.75z",clipRule:"evenodd"}))}const ns=h.forwardRef(ls),Ee=ns;function rs({title:s,titleId:t,...l},a){return h.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:a,"aria-labelledby":t},l),s?h.createElement("title",{id:t},s):null,h.createElement("path",{d:"M15 3.75H9v16.5h6V3.75zM16.5 20.25h3.375c1.035 0 1.875-.84 1.875-1.875V5.625c0-1.036-.84-1.875-1.875-1.875H16.5v16.5zM4.125 3.75H7.5v16.5H4.125a1.875 1.875 0 01-1.875-1.875V5.625c0-1.036.84-1.875 1.875-1.875z"}))}const as=h.forwardRef(rs),os=as;function is(s){switch(s){case W.SQL:return"SQL";case W.PY:return"Python";case W.YAML:case W.YML:return"YAML";default:return"Plain Text"}}function cs(s,t){return s.file.extension===W.SQL&&s.file.isLocal&&ne(t)}const F=function({text:t,children:l,className:a}){return e.jsxs("small",{className:x("font-bold whitespace-nowrap text-xs",a),children:[C(t)&&e.jsxs("span",{children:[t,":Â "]}),l]})};function ds({text:s,className:t}){return e.jsx("span",{className:x("font-normal",t),children:s})}function us({ok:s,className:t}){return e.jsx("span",{className:x("inline-block w-2 h-2 rounded-full",z(s)&&"bg-warning-500",Ie(s)&&"bg-success-500",M(s)&&"bg-danger-500",t)})}F.Text=ds;F.Light=us;const R={Model:"model",Test:"test",Audit:"audit",Macro:"macro",Hook:"hook",Log:"log",Config:"config",Seed:"seed",Metric:"metric",Schema:"schema",Unknown:"unknown"};function ms({tab:s}){const t=P(c=>c.isModel),l=g(c=>c.engine),a=g(c=>c.dialects),d=g(c=>c.refreshTab);h.useEffect(()=>{var i;const c=(i=a[0])==null?void 0:i.dialect_name;z(s.dialect)&&C(c)&&o(c)},[a,s]);function o(c){s.dialect=c,d(s),l.postMessage({topic:"dialect",payload:s.dialect})}return e.jsxs("div",{className:"flex w-full items-center px-2 min-h-[2rem]",children:[s.file.isRemote&&e.jsx(F,{className:"mr-2",text:"Saved",children:e.jsx(F.Light,{ok:M(s.file.isChanged)})}),s.file.isRemote&&s.file.isSQL&&e.jsx(F,{className:"mr-2",text:"Formatted",children:e.jsx(F.Light,{ok:s.file.isFormatted})}),e.jsx(F,{className:"mr-2",text:"Language",children:e.jsx(F.Text,{text:is(s.file.extension)})}),cs(s,a)&&e.jsx(F,{className:"mr-2",text:"Dialect",children:e.jsx(v,{size:w.sm,children:({className:c,size:i})=>e.jsx(v.Selector,{className:c,size:i,list:a.map(f=>({text:f.dialect_title,value:G(f.dialect_name)?"sqlglot":f.dialect_name})),onChange:f=>{o(f)},value:s.dialect})})}),t(s.file.path)&&!G(s.dialect)&&e.jsx(F,{className:"mr-2",text:"Dialect",children:e.jsx(F.Text,{text:s.dialect})}),e.jsx(F,{className:"mr-2",text:"SQLMesh Type",children:e.jsx(F.Text,{text:fs(s.file.path)})})]})}function fs(s){return G(s)?R.Unknown:s.startsWith("models")?R.Model:s.startsWith("tests")?R.Test:s.startsWith("logs")?R.Log:s.startsWith("macros")?R.Macro:s.startsWith("hooks")?R.Hook:s.startsWith("seeds")?R.Seed:s.startsWith("metrics")?R.Metric:["config.yaml","config.yml","config.py"].includes(s)?R.Config:["schema.yaml","schema.yml"].includes(s)?R.Schema:R.Unknown}function xs(){const s=P(r=>r.modules),t=P(r=>r.models),l=P(r=>r.lastSelectedModel),a=P(r=>r.setLastSelectedModel),d=H(r=>r.files),o=H(r=>r.selectedFile),c=H(r=>r.setSelectedFile),i=g(r=>r.tab),f=g(r=>r.tabs),n=g(r=>r.replaceTab),u=g(r=>r.createTab),y=g(r=>r.selectTab),T=g(r=>r.addTab),[p,N]=h.useMemo(()=>{const r=[],j=[];return f.forEach(b=>{b.file.isLocal&&r.push(b),b.file.isRemote&&j.push(b)}),[r,j]},[f]);h.useEffect(()=>{if(z(o)||(i==null?void 0:i.file)===o||o instanceof We||M(s.hasFiles))return;a(t.get(o.path));const r=u(o);C(i)&&i.file instanceof He&&M(i.file.isChanged)&&i.file.isRemote&&M(f.has(o))?n(i,r):T(r),y(r)},[o]),h.useEffect(()=>{if(z(l))return;const r=d.get(l.path);z(r)||c(r)},[l]);function S(){const r=u();T(r),y(r),c(r.file)}return e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"h-6 m-0 ml-1 mr-2 border-none",variant:L.Alternative,size:w.sm,onClick:r=>{r.stopPropagation(),S()},children:e.jsx($e,{className:"inline-block w-3 h-4"})}),e.jsxs("ul",{className:"w-full whitespace-nowrap min-h-[2rem] max-h-[2rem] overflow-hidden overflow-x-auto hover:scrollbar scrollbar--horizontal",children:[p.map((r,j)=>e.jsx(ve,{tab:r,title:`Custom SQL ${j+1}`},r.id)),N.map(r=>e.jsx(ve,{tab:r,title:r.file.name},r.id))]})]})}function ve({tab:s,title:t}){const l=h.useRef(null),a=P(u=>u.addConfirmation),d=H(u=>u.setSelectedFile),o=g(u=>u.tab),c=g(u=>u.selectTab),i=g(u=>u.closeTab);h.useEffect(()=>{z(s)||(s.el=l.current??void 0,(o==null?void 0:o.id)===s.id&&setTimeout(()=>{var u;(u=s==null?void 0:s.el)==null||u.scrollIntoView({behavior:"smooth",inline:"center"})},300))},[l,s,o]);function f(){s.file.isChanged?a({headline:"Closing Tab",description:"All unsaved changes will be lost. Do you want to close the tab anyway?",yesText:"Yes, Close Tab",noText:"No, Cancel",action:()=>{i(s.file)}}):i(s.file)}const n=s.file.id===(o==null?void 0:o.file.id);return e.jsx("li",{ref:l,className:x("inline-block py-1 pr-2 last-child:pr-0 overflow-hidden text-center overflow-ellipsis cursor-pointer"),onClick:u=>{u.stopPropagation(),c(s),d(s.file)},children:e.jsxs("span",{className:x("flex border-2 justify-between items-center pl-1 pr-1 py-[0.125rem] min-w-[8rem] rounded-md group border-transparent border-r border-r-theme-darker dark:border-r-theme-lighter",n?"bg-neutral-200 border-neutral-200 text-neutral-900 dark:bg-dark-lighter dark:border-dark-lighter dark:text-primary-500":"bg-trasparent hover:bg-theme-darker dark:hover:bg-theme-lighter"),children:[e.jsx("small",{className:"text-xs",children:t}),e.jsx("small",{className:x("group-hover:hidden text-xs inline-block ml-3 mr-1 w-2 h-2 rounded-full",s.file.isChanged?"bg-warning-500":"bg-transparent")}),e.jsx(Ge,{className:"hidden group-hover:inline-block text-neutral-600 dark:text-neutral-100 w-4 h-4 ml-2 mr-0 cursor-pointer",onClick:u=>{u.stopPropagation(),f()}})]})})}const be=24*60*60*1e3,hs=1e3,q=50;function ps({tab:s,isOpen:t=!0,toggle:l}){const a=P(c=>c.models),d=P(c=>c.isModel),o=h.useMemo(()=>a.get(s.file.path),[s,a]);return e.jsx("div",{className:x("flex flex-col w-full h-full items-center overflow-hidden"),children:d(s.file.path)?C(o)&&e.jsx(gs,{tab:s,model:o,isOpen:t,toggle:l}):e.jsx(js,{tab:s,isOpen:t,toggle:l})})}function gs({tab:s,model:t,isOpen:l=!0,toggle:a}){const d=P(i=>i.environment),o=P(i=>i.environments),c=Array.from(o).filter(({isRemote:i})=>i).map(({name:i})=>({text:i,value:i}));return e.jsxs(D.Group,{children:[e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx(I,{className:x("h-6 w-6 !px-0 border-none bg-neutral-10 dark:bg-neutral-20",l?"text-secondary-500 dark:text-secondary-300":"text-neutral-500 dark:text-neutral-300"),variant:L.Info,size:w.sm,onClick:i=>{i.stopPropagation(),a==null||a()},children:e.jsx(Ee,{className:"w-4 h-4"})}),l&&e.jsx(oe,{className:"flex justify-center items-center",list:["Evaluate","Columns",c.length>1&&d.isRemote&&"Diff"].filter(Boolean)})]}),l&&e.jsxs(D.Panels,{className:"h-full w-full overflow-hidden",children:[e.jsx(D.Panel,{unmount:!1,className:x("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(ws,{model:t})}),e.jsx(D.Panel,{unmount:!1,className:"text-xs w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 px-2",children:e.jsx(Xe,{className:"max-h-[15rem]",nodeId:t.name,columns:t.columns,disabled:t.isModelPython,withHandles:!1,withSource:!1,withDescription:!0,limit:10})}),c.length>1&&d.isRemote&&e.jsx(D.Panel,{unmount:!1,className:x("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ns,{tab:s,model:t,list:c.filter(({value:i})=>d.name!==i),target:{text:d.name,value:d.name}})})]})]})}function js({tab:s,isOpen:t=!0,toggle:l}){return e.jsxs(D.Group,{children:[e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx(I,{className:x("h-6 w-6 !px-0 border-none bg-neutral-10 dark:bg-neutral-20",t?"text-secondary-500 dark:text-secondary-300":"text-neutral-500 dark:text-neutral-300"),variant:L.Info,size:w.sm,onClick:a=>{a.stopPropagation(),l==null||l()},children:e.jsx(Ee,{className:"w-4 h-4"})}),t&&e.jsx(oe,{className:"flex justify-center items-center",list:["Run Query","Diff"]})]}),t&&e.jsxs(D.Panels,{className:"h-full w-full overflow-hidden",children:[e.jsx(D.Panel,{unmount:!1,className:x("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(bs,{tab:s})}),e.jsx(D.Panel,{unmount:!1,className:x("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(ys,{})})]})]})}function vs({children:s}){return e.jsx("fieldset",{className:"flex my-3",children:s})}function J({children:s}){return e.jsx("div",{className:"flex w-full h-full py-1 overflow-hidden overflow-y-auto hover:scrollbar scrollbar--vertical",children:s})}function Z({children:s}){return e.jsx("div",{className:"flex w-full py-1 px-1 justify-end",children:s})}function bs({tab:s}){const t=g(f=>f.setPreviewQuery),l=g(f=>f.setPreviewTable),a=g(f=>f.engine),{refetch:d,isFetching:o,cancel:c}=we({sql:s.file.content});h.useEffect(()=>()=>{c()},[]);function i(){l(void 0),t(s.file.content),d().then(({data:f})=>{l(ie(f))})}return e.jsxs(e.Fragment,{children:[e.jsx(J,{}),e.jsx($,{}),e.jsxs(Z,{children:[e.jsx(I,{size:w.sm,variant:L.Alternative,onClick:f=>{f.stopPropagation(),a.postMessage({topic:"format",payload:{sql:s.file.content}})},children:"Format"}),o?e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Running Query..."}),e.jsx(I,{size:w.sm,variant:L.Danger,onClick:f=>{f.stopPropagation(),c()},children:"Cancel"})]}):e.jsx(I,{size:w.sm,variant:L.Alternative,disabled:o,onClick:f=>{f.stopPropagation(),i()},children:"Run Query"})]})]})}function ws({model:s}){const t=P(p=>p.environment),l=P(p=>p.isModel),a=g(p=>p.setPreviewQuery),d=g(p=>p.setPreviewTable),[o,c]=h.useState({model:s.displayName,start:ee(pe(Date.now()-be)),end:ee(new Date),execution_time:ee(pe(Date.now()-be)),limit:1e3}),{refetch:i}=Re(o),{refetch:f,isFetching:n,cancel:u}=ze(o),y=l(s.path)&&Object.values(o).every(Boolean);h.useEffect(()=>()=>{u()},[]);function T(){a(void 0),d(void 0),i().then(({data:p})=>{a(p==null?void 0:p.sql)}),f().then(({data:p})=>{d(ie(p))})}return e.jsxs(e.Fragment,{children:[e.jsx(J,{children:e.jsxs("form",{className:"w-full",children:[M(y)&&e.jsx(vs,{children:e.jsx(je,{variant:L.Warning,children:e.jsxs(je.Description,{className:"w-full mr-2 text-sm",children:["Please fill out all fields to ",e.jsx("b",{children:"evaluate the model"}),"."]})})}),e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(v,{className:"w-full mx-0",label:"Start Date",size:w.sm,children:({className:p})=>e.jsx(v.Textfield,{className:x(p,"w-full"),placeholder:"02/11/2023",value:o.start,onInput:N=>{N.stopPropagation(),c({...o,start:N.target.value??""})}})}),e.jsx(v,{className:"w-full mx-0",label:"End Date",size:w.sm,children:({className:p})=>e.jsx(v.Textfield,{className:x(p,"w-full"),placeholder:"02/13/2023",value:o.end,onInput:N=>{N.stopPropagation(),c({...o,end:N.target.value??""})}})}),e.jsx(v,{className:"w-full mx-0",label:"Execution Time",size:w.sm,children:({className:p})=>e.jsx(v.Textfield,{className:x(p,"w-full"),placeholder:"02/13/2023",value:o.execution_time,onInput:N=>{N.stopPropagation(),c({...o,execution_time:N.target.value??""})}})}),C(o.limit)&&e.jsx(v,{className:"w-full mx-0",label:"Limit",size:w.sm,children:({className:p})=>e.jsx(v.Textfield,{className:x(p,"w-full"),type:"number",placeholder:"1000",value:o.limit,onInput:N=>{N.stopPropagation(),c({...o,limit:N.target.valueAsNumber??hs})}})})]})]})}),e.jsx($,{}),e.jsx(Z,{children:e.jsx("div",{className:"flex w-full justify-end",children:l(s.path)&&n?e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Evaluating..."}),e.jsx(I,{size:w.sm,variant:L.Danger,onClick:p=>{p.stopPropagation(),u()},children:"Cancel"})]}):e.jsx(I,{size:w.sm,variant:L.Alternative,disabled:M(y)||n||t.isInitialProd,onClick:p=>{p.stopPropagation(),T()},children:"Evaluate"})})})]})}function Ns({tab:s,model:t,list:l,target:a}){const d=P(E=>E.isModel),o=g(E=>E.setPreviewDiff),[c,i]=h.useState(l[0].value),[f,n]=h.useState(q),[u,y]=h.useState(""),[T,p]=h.useState(""),{refetch:N,isFetching:S,cancel:r}=Ne({source:c,target:a.value,model_or_snapshot:t.name,limit:f,on:u,where:T}),j=h.useCallback(()=>{o(void 0),N().then(({data:E})=>{o(E)})},[t.name]);h.useEffect(()=>()=>{r()},[]),h.useEffect(()=>{i(l[0].value)},[l]);const b=d(s.file.path)&&[c,a,f].every(Boolean);return e.jsxs(e.Fragment,{children:[e.jsx(J,{children:e.jsx("form",{className:"w-full",children:e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(v,{className:"w-full mx-0",label:"Source",disabled:l.length<2,size:w.sm,children:({disabled:E,className:k})=>e.jsx(v.Selector,{className:x(k,"w-full"),list:l,value:c,disabled:E,onChange:i})}),e.jsx(v,{className:"w-full mx-0",label:"Target",disabled:!0,children:({disabled:E,className:k})=>e.jsx(v.Textfield,{className:x(k,"w-full"),disabled:E,value:a.value})}),e.jsx(v,{className:"w-full mx-0",label:"Limit",size:w.sm,children:({className:E})=>e.jsx(v.Textfield,{className:x(E,"w-full"),type:"number",placeholder:"1000",value:f,onInput:k=>{k.stopPropagation(),n(k.target.valueAsNumber??q)}})}),e.jsx(v,{className:"w-full mx-0",label:"ON",size:w.sm,children:({className:E})=>e.jsx(v.Textfield,{className:x(E,"w-full"),placeholder:"s.id = t.id",value:u,onInput:k=>{k.stopPropagation(),y(k.target.value)}})}),e.jsx(v,{className:"w-full mx-0",label:"WHERE",size:w.sm,children:({className:E})=>e.jsx(v.Textfield,{className:x(E,"w-full"),placeholder:"id > 10",value:T,onInput:k=>{k.stopPropagation(),p(k.target.value)}})})]})})}),e.jsx($,{}),e.jsx(Z,{children:e.jsx("div",{className:"flex w-full justify-end items-center px-2",children:S?e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Getting Diff..."}),e.jsx(I,{size:w.sm,variant:L.Danger,onClick:E=>{E.stopPropagation(),r()},children:"Cancel"})]}):e.jsx(I,{className:"ml-2",size:w.sm,variant:L.Alternative,disabled:M(b)||S,onClick:E=>{E.stopPropagation(),j()},children:"Get Diff"})})})]})}function ys(){const s=g(r=>r.setPreviewDiff),[t,l]=h.useState(""),[a,d]=h.useState(""),[o,c]=h.useState(q),[i,f]=h.useState(""),[n,u]=h.useState(""),{refetch:y,isFetching:T,cancel:p}=Ne({source:t,target:a,limit:o,on:i,where:n});h.useEffect(()=>()=>{p()},[]);function N(){s(void 0),y().then(({data:r})=>{s(r)})}const S=[t,a,o,i].every(Boolean);return e.jsxs(e.Fragment,{children:[e.jsx(J,{children:e.jsx("form",{className:"w-full",children:e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(v,{className:"w-full mx-0",label:"Source",size:w.sm,children:({className:r})=>e.jsx(v.Textfield,{className:x(r,"w-full"),placeholder:"exp.tst_model__dev",value:t,onInput:j=>{j.stopPropagation(),l(j.target.value)}})}),e.jsx(v,{className:"w-full mx-0",label:"Target",size:w.sm,children:({className:r})=>e.jsx(v.Textfield,{className:x(r,"w-full"),placeholder:"exp.tst_snapshot__1353336088",value:a,onInput:j=>{j.stopPropagation(),d(j.target.value)}})}),e.jsx(v,{className:"w-full mx-0",label:"Limit",size:w.sm,children:({className:r})=>e.jsx(v.Textfield,{className:x(r,"w-full"),type:"number",placeholder:"1000",value:o,onInput:j=>{j.stopPropagation(),c(j.target.valueAsNumber??q)}})}),e.jsx(v,{className:"w-full mx-0",label:"ON",size:w.sm,children:({className:r})=>e.jsx(v.Textfield,{className:x(r,"w-full"),placeholder:"s.id = t.id",value:i,onInput:j=>{j.stopPropagation(),f(j.target.value)}})}),e.jsx(v,{className:"w-full mx-0",label:"WHERE",size:w.sm,children:({className:r})=>e.jsx(v.Textfield,{className:x(r,"w-full"),placeholder:"id > 10",value:n,onInput:j=>{j.stopPropagation(),u(j.target.value)}})})]})})}),e.jsx($,{}),e.jsx(Z,{children:T?e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Getting Diff..."}),e.jsx(I,{size:w.sm,variant:L.Danger,onClick:r=>{r.stopPropagation(),p()},children:"Cancel"})]}):e.jsx(I,{className:"ml-2",size:w.sm,variant:L.Alternative,disabled:M(S)||T,onClick:r=>{r.stopPropagation(),N()},children:"Get Diff"})})]})}const V="s__",U="t__",ce="NULL";function Ts({source_schema:s,target_schema:t},l,a){const d=Array.from(new Set(a.flat())),o=Object.keys(s),c=Object.keys(t),f=Array.from(new Set(o.concat(c))).filter(y=>o.includes(y)&&c.includes(y)),n=o.filter(y=>!c.includes(y)),u=c.filter(y=>!o.includes(y));return{all:Array.from(new Set([d,l.modifiedColumns&&f,l.addedColumns&&u,l.removedColumns&&n].filter(Boolean).flat())),added:u.length,deleted:n.length,modified:f.length-d.length}}function Es(s,t,l){const a=Object.values(s.row_diff.sample)[0]??{},d=[],o=[],c=[];return Object.keys(a).forEach(i=>{B(s,i,l)?o.push(i):O(s,i,l)?d.push(i):c.push(i)}),{all:[t.modifiedRows&&c,t.addedRows&&o,t.removedRows&&d].filter(Boolean).flat(),added:o.length,deleted:d.length,modified:c.length}}function ae(s,t,l){const a=A(s,V,t,l),d=A(s,U,t,l);return a!==d}function O(s,t,l){return l.every(([a,d])=>{const o=A(s,V,a,t),c=A(s,U,d,t);return C(o)&&z(c)})}function B(s,t,l){return l.every(([a,d])=>{const o=A(s,V,a,t),c=A(s,U,d,t);return z(o)&&C(c)})}function te(s,t,l,a){return l in s.schema_diff.added||l in s.schema_diff.removed?!1:t.some(d=>M(B(s,d,a))&&M(O(s,d,a))&&ae(s,l,d))}function A(s,t,l,a){var d;return(d=s.row_diff.sample[`${t}${l}`])==null?void 0:d[a]}function Cs(s,t,l){return A(s,V,t,l)??ce}function Ps(s,t,l){return A(s,U,t,l)??ce}function Ss({diff:s}){const[t,l]=h.useState({modifiedRows:!0,addedRows:!0,removedRows:!0,modifiedColumns:!0,addedColumns:!0,removedColumns:!0}),a=Ts(s.schema_diff,t,s.on),d=Es(s,t,s.on),o=t.addedRows&&!t.removedRows&&!t.modifiedRows,c=!t.addedRows&&t.removedRows&&!t.modifiedRows,i=Array.from(new Set(s.on.flat())),f=Object.values(s.row_diff.sample).some(n=>Object.keys(n).length>0);return e.jsxs("div",{className:"px-2 h-full flex flex-col rounded-lg",children:[f&&e.jsxs(e.Fragment,{children:[e.jsx(Ms,{diff:s,rows:d,columns:a}),e.jsx("div",{className:"mt-2 mb-1 flex rounded-lg items-center",children:e.jsx("div",{className:"w-full flex justify-end items-center",children:e.jsx(Ve,{options:Object.keys(t).reduce((n,u)=>(n[u]=y=>l(T=>({...T,[u]:y})),n),{}),value:Object.keys(t).map(n=>M(t[n])?void 0:n).filter(Boolean)})})})]}),e.jsx("div",{className:"overflow-auto h-full hover:scrollbar scrollbar--horizontal scrollbar--vertical",children:e.jsxs("table",{cellPadding:0,cellSpacing:0,className:"w-full text-xs text-neutral-600 dark:text-neutral-200 font-normal border-separate",children:[e.jsx("thead",{className:"sticky bg-theme top-0 z-10",children:e.jsx("tr",{children:a.all.map(n=>e.jsx("th",{colSpan:te(s,d.all,n,s.on)?2:1,className:x("text-left whitespace-nowrap py-1 px-2 font-bold",n in s.schema_diff.added?"border-t-2 border-l-2 border-r-2 border-success-500":n in s.schema_diff.removed?"border-t-2 border-l-2 border-r-2 border-danger-500":i.includes(n)?"border-brand-500 border-l-2 border-t-2 border-r-2":"border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",i.includes(n)?"bg-brand-10":"bg-neutral-5"),children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"mr-2",children:[e.jsx("span",{children:n}),"Â ",e.jsxs("small",{className:"text-neutral-500 font-medium",children:["(",s.schema_diff.source_schema[n]??s.schema_diff.target_schema[n],")"]})]}),M(i.includes(n))&&e.jsx("div",{className:"ml-2",children:e.jsxs("small",{className:"inline-block bg-neutral-10 px-2 py-0.5 rounded-full",children:[Math.round(d.all.filter(u=>ae(s,n,u)).length/d.all.length*100),"%"]})})]})},n))})}),e.jsx("tbody",{children:ne(d.all)?d.all.map(n=>e.jsx("tr",{children:a.all.map(u=>te(s,d.all,u,s.on)?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:x("p-1 border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",B(s,n,s.on)&&"bg-success-10 text-success-500",O(s,n,s.on)&&"bg-danger-5 text-danger-500"),children:e.jsx("div",{className:x("px-2 py-1 whitespace-nowrap font-bold rounded-md ",B(s,n,s.on)&&"bg-success-10 text-success-500",O(s,n,s.on)&&"bg-danger-5 text-danger-500"),children:Cs(s,u,n)})},`${n}-${u}-source`),e.jsx("td",{className:x("p-1 border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",B(s,n,s.on)&&"bg-success-10 text-success-500",O(s,n,s.on)&&"bg-danger-5 text-danger-500"),children:e.jsx("div",{className:x("px-2 py-1 whitespace-nowrap font-bold rounded-md",ae(s,u,n)&&"bg-primary-10 text-primary-500",B(s,n,s.on)&&"!bg-success-10 !text-success-500",O(s,n,s.on)&&"!bg-danger-5 !text-danger-500"),children:Ps(s,u,n)})},`${n}-${u}-target`)]}):e.jsx("td",{className:x("p-1",u in s.schema_diff.added?"bg-success-10 border-l-2 border-r-2 border-success-500 text-success-500 font-bold":u in s.schema_diff.removed?"bg-danger-5 border-l-2 border-r-2 border-danger-500 !text-danger-500 font-bold":i.includes(u)?"border-brand-500 border-l-2 border-r-2":"border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",O(s,n,s.on)&&"!bg-danger-5 text-danger-500 font-bold",B(s,n,s.on)&&"bg-success-10 text-success-500 font-bold"),children:e.jsx("div",{className:x("px-2 py-1 whitespace-nowrap rounded-md",(u in s.schema_diff.added||B(s,n,s.on))&&"bg-success-10 text-success-500 font-bold",(u in s.schema_diff.removed||O(s,n,s.on))&&"!bg-danger-5 !text-danger-500 font-bold"),children:A(s,V,u,n)??A(s,U,u,n)??ce})},`${n}-${u}`))},n)):e.jsx(Ue,{columns:a.all.length>0?a.all.length:void 0})}),ne(d.all)&&e.jsx("tfoot",{className:"sticky bg-theme bottom-0",children:e.jsx("tr",{children:a.all.map(n=>te(s,d.all,n,s.on)?e.jsxs(e.Fragment,{children:[e.jsx("th",{className:x("text-left whitespace-nowrap px-2 py-1 border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",i.includes(n)?"bg-brand-10":"bg-neutral-10"),children:"Source"},`${n}-source`),e.jsx("th",{className:x("text-left whitespace-nowrap px-2 py-1 border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",i.includes(n)?"bg-brand-10":"bg-primary-10"),children:"Target"},`${n}-target`)]}):e.jsxs("th",{className:x("text-left whitespace-nowrap px-2 py-1 font-bold",n in s.schema_diff.added?"border-b-2 border-l-2 border-r-2 border-success-500":n in s.schema_diff.removed?"border-b-2 border-l-2 border-r-2 border-danger-500":i.includes(n)?"border-brand-500 border-l-2 border-b-2 border-r-2":"border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",i.includes(n)?"bg-brand-10":"bg-neutral-10"),children:[(n in s.schema_diff.removed||c)&&e.jsx("span",{children:"Source"}),(n in s.schema_diff.added||o)&&e.jsx("span",{children:"Target"})]},n))})})]})}),e.jsxs("div",{className:"flex justify-between items-center px-2 mt-2",children:[e.jsx(Ye,{count:d.all.length}),e.jsx(ks,{})]})]})}function ks(){const s=[["Grain","bg-brand-500"],["Changed","bg-primary-500"],["Added","bg-success-500"],["Deleted","bg-danger-500"]];return e.jsx("div",{className:"flex text-xs",children:s.map(([t="",l])=>e.jsx(Ds,{text:t,className:l},t))})}function Ds({text:s,className:t}){return e.jsxs("div",{className:"flex ml-2 items-center",children:[e.jsx("span",{className:x("inline-block w-3 h-3 mr-2 rounded-full",t)}),e.jsx("small",{className:"text-neutral-600 dark:text-neutral-400",children:s})]})}function Ms({diff:s,rows:t,columns:l}){return e.jsx(se,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(se.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter text-neutral-600 dark:text-neutral-400",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Stats"}),a?e.jsx(es,{className:"h-6 w-6 text-primary-500"}):e.jsx(ss,{className:"h-6 w-6 text-primary-500"})]}),e.jsx(se.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:e.jsxs("div",{className:"p-2 grid grid-cols-3 gap-4 mb-3",children:[e.jsx(le,{text:"Row Count Change",children:e.jsxs("p",{className:"text-6xl font-light text-primary-500 mt-3",children:[Math.round(Math.abs(s.row_diff.count_pct_change)),e.jsx("small",{className:"text-sm",children:"%"})]})}),e.jsxs(le,{text:"Column Count Change",count:t.all.length,children:[e.jsx("p",{className:"text-center text-6xl font-light text-primary-500 mt-3",children:t.modified}),e.jsx("p",{className:"text-center text-6xl font-light text-success-500 mt-3",children:t.added}),e.jsx("p",{className:"text-center text-6xl font-light text-danger-500 mt-3",children:t.deleted})]}),e.jsxs(le,{text:"Column Changes",count:l.all.length,children:[e.jsx("p",{className:"text-center text-6xl font-light text-primary-500 mt-3",children:l.modified}),e.jsx("p",{className:"text-center text-6xl font-light text-success-500 mt-3",children:l.added}),e.jsx("p",{className:"text-center text-6xl font-light text-danger-500 mt-3",children:l.deleted})]})]})})]})})}function le({text:s,children:t,className:l,count:a}){return e.jsxs("div",{className:x("rounded-xl overflow-hidden px-3 py-6 bg-primary-10",l),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h3",{className:"text-neutral-500 dark:text-neutral-300 text-sm font-bold",children:s}),C(a)&&e.jsx("div",{children:e.jsx("small",{className:"inline-block px-2 py-0.5 bg-neutral-10 rounded-full",children:a})})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:t})]})}const _s=h.lazy(async()=>await Ae(()=>import("./ModelLineage-9a36c7db.js"),["assets/ModelLineage-9a36c7db.js","assets/index-71398e80.js","assets/index-d2351485.css","assets/context-c9a4c85e.js","assets/_commonjs-dynamic-modules-302442b1.js","assets/Input-0c327896.js","assets/editor-7738dbd6.js","assets/file-49f2b60f.js","assets/project-1647c629.js","assets/transition-7cc1de49.js","assets/context-b6aa14d4.css","assets/ListboxShow-097350f3.js","assets/SearchList-b383624c.js"])),Q={Query:"Query",Table:"Data Preview",Console:"Logs",Lineage:"Lineage",Diff:"Diff",Errors:"Errors"};function Ls({tab:s,className:t}){const{errors:l}=ye(),a=Qe(),d=P(b=>b.models),o=P(b=>b.isModel),c=g(b=>b.direction),i=g(b=>b.previewQuery),f=g(b=>b.previewTable),n=g(b=>b.previewDiff),u=g(b=>b.setDirection),[y,T]=h.useState(-1),p=Te(s.file.path,b=>{a(`${Oe.DocsModels}/${b.name}`)}),N=d.get(s.file.path),S=M(s.file.isEmpty)&&C(N)&&o(s.file.path),r=l.size>0&&([f,n].some(C)||S),j=h.useMemo(()=>[C(f)&&Q.Table,C(i)&&Q.Query,S&&Q.Lineage,C(n)&&Q.Diff,r&&Q.Errors].filter(Boolean),[s.id,f,i,n,S,l,r]);return h.useEffect(()=>{r?T(j.indexOf(Q.Errors)):C(n)?T(j.indexOf(Q.Diff)):C(f)?T(j.indexOf(Q.Table)):S&&T(j.indexOf(Q.Lineage))},[j,f,i,n,S,l,r]),e.jsx("div",{className:x("w-full h-full flex flex-col text-prose overflow-auto hover:scrollbar scrollbar--vertical",t),children:Be(j)?e.jsx("div",{className:"flex justify-center items-center w-full h-full",children:e.jsx("h3",{className:"text-md",children:"No Data To Preview"})}):e.jsxs(D.Group,{onChange:T,selectedIndex:y,children:[e.jsx(oe,{list:j,children:e.jsx("div",{className:"ml-2",children:e.jsx(I,{className:"!m-0 !py-0.5 px-[0.25rem] border-none",variant:L.Alternative,size:w.sm,onClick:()=>{u(c==="horizontal"?"vertical":"horizontal")},children:e.jsx(os,{"aria-label":c==="horizontal"?"Use vertical layout":"Use horizontal layout",className:"text-primary-500 w-5"})})})},j.join("-")),e.jsxs(D.Panels,{className:"h-full w-full overflow-hidden",children:[C(f)&&e.jsx(D.Panel,{unmount:!1,className:x("w-full h-full pt-4 relative px-2","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(qe,{data:f})}),C(i)&&e.jsx(D.Panel,{unmount:!1,className:"w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 p-2",children:e.jsx("div",{className:"w-full h-full p-2 bg-primary-10 rounded-lg overflow-auto hover:scrollbar scrollbar--horizontal scrollbar--vertical",children:e.jsx(re,{type:W.SQL,content:i??"",extensions:p,className:"text-xs"})})}),S&&e.jsx(D.Panel,{unmount:!1,className:x("w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 py-2"),children:e.jsx(_s,{model:N},s.file.fingerprint)}),C(n==null?void 0:n.row_diff)&&e.jsx(D.Panel,{unmount:!1,className:x("w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 py-2"),children:e.jsx(Ss,{diff:n},s.id)}),r&&e.jsx(D.Panel,{unmount:!1,className:"w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 py-2",children:e.jsx("ul",{className:"w-full h-full p-2 overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:Array.from(l).reverse().map(b=>e.jsx("li",{className:"bg-danger-10 mb-4 last:m-0 p-2 rounded-md",children:e.jsx(ts,{scope:b.key,error:b})},b.id))})})]})]},s.id)})}function de(){const s=g(t=>t.tab);return e.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden",children:[e.jsx(xs,{}),e.jsx($,{}),z(s)?e.jsx(ue,{}):e.jsx(Ce,{tab:s})]})}function ue(){return e.jsx("div",{className:"flex justify-center items-center w-full h-full",children:e.jsx("div",{className:"p-4 text-center text-theme-darker dark:text-theme-lighter",children:e.jsx("h2",{className:"text-3xl",children:"Select File or Add New SQL Tab"})})})}function Ce({tab:s}){const{errors:t}=ye(),l=P(m=>m.environment),a=P(m=>m.models),d=P(m=>m.isModel),o=H(m=>m.files),c=H(m=>m.selectedFile),i=H(m=>m.setSelectedFile),f=g(m=>m.direction),n=g(m=>m.engine),u=g(m=>m.previewTable),y=g(m=>m.previewDiff),T=g(m=>m.refreshTab),p=g(m=>m.setPreviewQuery),N=g(m=>m.setPreviewTable),S=g(m=>m.setPreviewDiff),r=g(m=>m.setDialects),{setManuallySelectedColumn:j}=Je(),b=h.useCallback(function(m){i(o.get(m.path))},[o]),E=h.useCallback(function(m,_){j([m,_])},[]),k=Ze(),me=Te(s.file.path,b,E),[fe,K]=h.useState(!1),Pe=h.useMemo(()=>[...k,{key:"Ctrl-Enter",preventDefault:!0,run(){return ke(),!0}}],[k]),xe=h.useCallback(m=>{if(m.data.topic==="dialects"){const _=a.get(s.file.path);s.dialect=(_==null?void 0:_.dialect)??"",r(m.data.payload),T(s)}if(m.data.topic==="format"){if(G(m.data.payload))return;s.file.content=m.data.payload,T(s)}},[s.id]),he=h.useCallback(function(_){s.file.content=_,T(s)},[s.id]);h.useEffect(()=>(n.addEventListener("message",xe),K(!1),z(c)&&i(s==null?void 0:s.file),()=>{n.removeEventListener("message",xe)}),[s.id]),h.useEffect(()=>{p(void 0),N(void 0),S(void 0)},[s.id,s.file.fingerprint]),h.useEffect(()=>{S(void 0)},[l]);const{refetch:Se}=we({sql:s.file.content});function ke(){N(void 0),p(s.file.content),Se().then(({data:m})=>{N(ie(m))})}function De(){const m=a.get(s.file.path),_=M(s.file.isEmpty)&&C(m)&&d(s.file.path);return(s.file.isLocal||t.size>0)&&[u,y].some(Boolean)||_?[70,30]:[100,0]}function Me(){const m=a.get(s==null?void 0:s.file.path);return fe&&(C(m)&&d(s.file.path)||s.file.isLocal)&&M(G(s.file.content))?[70,30]:[100,0]}const Y=32,_e=2;return e.jsxs(ge,{className:x("w-full h-full overflow-hidden",f==="vertical"?"flex flex-col":"flex"),sizes:De(),direction:f,minSize:[Y,0],snapOffset:0,children:[e.jsxs("div",{className:x("flex flex-col",f==="vertical"?"w-full ":"h-full"),children:[e.jsxs(ge,{className:"flex h-full overflow-hidden",sizes:Me(),minSize:Y,snapOffset:Y,handleDrag:(m,_)=>{const Fe=_.parent.getBoundingClientRect().width*(m[1]??0)/100;K(Fe>=Y+_e)},children:[e.jsxs("div",{className:"flex flex-col h-full",children:[s.file.isLocal&&e.jsx(re,{type:W.SQL,dialect:s.dialect,keymaps:Pe,content:s.file.content,extensions:me,onChange:he}),s.file.isRemote&&e.jsx(Ke,{keymaps:k,path:s.file.path,children:({file:m,keymaps:_})=>e.jsx(re,{type:m.extension,dialect:s.dialect,extensions:me,keymaps:_,content:m.content,onChange:he})})]}),e.jsx("div",{className:"flex flex-col h-full",children:e.jsx(ps,{tab:s,toggle:()=>K(m=>!m),isOpen:fe})})]},s.id),e.jsx($,{}),e.jsx(ms,{tab:s},s.file.fingerprint)]}),e.jsx(Ls,{tab:s,className:x(f==="vertical"?"flex flex-col":"flex")})]},f)}de.Empty=ue;de.Loading=ue;de.Main=Ce;export{de as default};
