import{r as l,R as i,w as k,as as ve,e as oe,i as P,j as t,c as D,v as G,B as le,aB as ye,h as re,k as q,V as je,X as Ce,aC as Ee,L as ie,S as ce,C as Q,F as Me}from"./index-71398e80.js";import{d as Se,e as de,s as me,f as Z,P as ue,h as Y,b as _,E as R,i as ke,j as ee,M as ze,k as Le,R as Ie,l as Ae,m as Be,n as te,o as se,p as ne,q as He,r as Re,t as De,v as Te}from"./context-c9a4c85e.js";import{a as Ue}from"./editor-7738dbd6.js";import{X as _e,L as We}from"./ListboxShow-097350f3.js";import{S as Oe}from"./SearchList-b383624c.js";import{z as $e}from"./Input-0c327896.js";import{w as X}from"./transition-7cc1de49.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./file-49f2b60f.js";import"./project-1647c629.js";function Ve({title:e,titleId:s,...n},f){return l.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:f,"aria-labelledby":s},n),e?l.createElement("title",{id:s},e):null,l.createElement("path",{fillRule:"evenodd",d:"M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z",clipRule:"evenodd"}))}const Fe=l.forwardRef(Ve),Pe=Fe;function Ge(){return i.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},i.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function Ke(){return i.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},i.createElement("path",{d:"M0 0h32v4.2H0z"}))}function Xe(){return i.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},i.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function qe(){return i.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},i.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function Ze(){return i.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},i.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const V=({children:e,className:s,...n})=>i.createElement("button",{type:"button",className:Y(["react-flow__controls-button",s]),...n},e);V.displayName="ControlButton";const Ye=e=>({isInteractive:e.nodesDraggable||e.nodesConnectable||e.elementsSelectable,minZoomReached:e.transform[2]<=e.minZoom,maxZoomReached:e.transform[2]>=e.maxZoom}),he=({style:e,showZoom:s=!0,showFitView:n=!0,showInteractive:f=!0,fitViewOptions:o,onZoomIn:a,onZoomOut:x,onFitView:m,onInteractiveChange:v,className:g,children:u,position:w="bottom-left"})=>{const b=Se(),[y,j]=l.useState(!1),{isInteractive:h,minZoomReached:p,maxZoomReached:c}=de(Ye,me),{zoomIn:d,zoomOut:r,fitView:C}=Z();if(l.useEffect(()=>{j(!0)},[]),!y)return null;const M=()=>{d(),a==null||a()},E=()=>{r(),x==null||x()},A=()=>{C(o),m==null||m()},N=()=>{b.setState({nodesDraggable:!h,nodesConnectable:!h,elementsSelectable:!h}),v==null||v(!h)};return i.createElement(ue,{className:Y(["react-flow__controls",g]),position:w,style:e,"data-testid":"rf__controls"},s&&i.createElement(i.Fragment,null,i.createElement(V,{onClick:M,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:c},i.createElement(Ge,null)),i.createElement(V,{onClick:E,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:p},i.createElement(Ke,null))),n&&i.createElement(V,{className:"react-flow__controls-fitview",onClick:A,title:"fit view","aria-label":"fit view"},i.createElement(Xe,null)),f&&i.createElement(V,{className:"react-flow__controls-interactive",onClick:N,title:"toggle interactivity","aria-label":"toggle interactivity"},h?i.createElement(Ze,null):i.createElement(qe,null)),u)};he.displayName="Controls";var Je=l.memo(he),z;(function(e){e.Lines="lines",e.Dots="dots",e.Cross="cross"})(z||(z={}));function Qe({color:e,dimensions:s,lineWidth:n}){return i.createElement("path",{stroke:e,strokeWidth:n,d:`M${s[0]/2} 0 V${s[1]} M0 ${s[1]/2} H${s[0]}`})}function et({color:e,radius:s}){return i.createElement("circle",{cx:s,cy:s,r:s,fill:e})}const tt={[z.Dots]:"#91919a",[z.Lines]:"#eee",[z.Cross]:"#e2e2e2"},st={[z.Dots]:1,[z.Lines]:1,[z.Cross]:6},nt=e=>({transform:e.transform,patternId:`pattern-${e.rfId}`});function pe({id:e,variant:s=z.Dots,gap:n=20,size:f,lineWidth:o=1,offset:a=2,color:x,style:m,className:v}){const g=l.useRef(null),{transform:u,patternId:w}=de(nt,me),b=x||tt[s],y=f||st[s],j=s===z.Dots,h=s===z.Cross,p=Array.isArray(n)?n:[n,n],c=[p[0]*u[2]||1,p[1]*u[2]||1],d=y*u[2],r=h?[d,d]:c,C=j?[d/a,d/a]:[r[0]/a,r[1]/a];return i.createElement("svg",{className:Y(["react-flow__background",v]),style:{...m,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:g,"data-testid":"rf__background"},i.createElement("pattern",{id:w+e,x:u[0]%c[0],y:u[1]%c[1],width:c[0],height:c[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${C[0]},-${C[1]})`},j?i.createElement(et,{color:b,radius:d/a}):i.createElement(Qe,{dimensions:r,color:b,lineWidth:o})),i.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${w+e})`}))}pe.displayName="Background";var at=l.memo(pe);const F={UNKNOWN:"UNKNOWN",STRUCT:"STRUCT"};function ot({id:e,data:s,sourcePosition:n,targetPosition:f}){const o=s??{},{connections:a,models:x,handleClickModel:m,lineage:v,selectedNodes:g,setSelectedNodes:u,mainNode:w,activeNodes:b,withConnected:y,connectedNodes:j,highlightedNodes:h}=_(),p=l.useMemo(()=>{var J;const L=x.get(e),B=(L==null?void 0:L.columns)??[];return Object.keys(((J=v[e])==null?void 0:J.columns)??{}).forEach(O=>{const $=B.find(({name:Ne})=>Ne===O);k($)&&B.push({name:O,type:F.UNKNOWN})}),B.forEach(O=>{let $=O.type??F.UNKNOWN;$.startsWith(F.STRUCT)&&($=F.STRUCT),O.type=$}),B},[e,x,v]),c=l.useMemo(()=>Object.values(h).flat(),[h]),[d,r]=l.useState(!1),C=l.useCallback(L=>{L.stopPropagation(),m==null||m(e)},[m,e,s.isInteractive]),M=l.useCallback(L=>{L.stopPropagation(),!(c.includes(e)||w===e)&&u(B=>(B.has(e)?B.delete(e):B.add(e),new Set(B)))},[u,c]),E=p.some(({name:L})=>a.get(ve(e,L))),A=Object.keys(h).length>0,N=Object.keys(h??{}).find(L=>h[L].includes(e)),K=h==null?void 0:h["*"],T=w===e,S=c.includes(e),H=g.has(e),W=w!==e&&G(m),U=o.type===R.cte,I=o.type===R.external,ge=o.type===R.seed,fe=o.type===R.python,xe=o.type===R.unknown,we=(E||o.withColumns||d||H||T)&&oe(p)&&P(A),be=g.size>0||b.size>0||y?H||b.has(e)||y&&j.has(e):j.has(e);return t.jsxs("div",{onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),className:D("text-xs font-semibold rounded-lg shadow-lg relative z-1",U?"text-neutral-100":"text-secondary-500 dark:text-primary-100",(I||ge)&&"border-4 border-accent-500 ring-8 ring-accent-200",H&&"border-4 border-secondary-500 ring-8 ring-secondary-200",k(N)?T?"ring-8 ring-brand-200":K:N,(A?S:be)||T?"opacity-100":"opacity-40 hover:opacity-100"),style:{maxWidth:k(o.width)?"auto":`${o.width}px`},children:[t.jsx(ke,{id:e,type:o.type,label:o.label,isSelected:H,isDraggable:!0,className:D("rounded-md",U?"bg-accent-500":T?"bg-brand-500 text-brand-100 font-black":"bg-secondary-100 dark:bg-primary-900"),hasLeft:f===ee.Left,hasRight:n===ee.Right,handleClick:W?C:void 0,handleSelect:w===e||U||c.includes(e)?void 0:M,count:p.length}),we&&t.jsxs(t.Fragment,{children:[t.jsx(ze,{className:"max-h-[15rem]",nodeId:e,columns:p,disabled:fe||xe,withHandles:!0,withSource:!0,withDescription:!1}),t.jsx("div",{className:D("rounded-b-md py-1",U?"bg-accent-500":T?"bg-brand-500":"bg-secondary-100 dark:bg-primary-900")})]})]})}function lt({handleSelect:e}){const{models:s,lineage:n,mainNode:f,connectedNodes:o}=_(),[a,x]=l.useState(!1),[m,v]=l.useState([]),[g,u]=l.useState(!1);l.useEffect(()=>{v([])},[f,s,n]);function w(){x(!0)}function b(){x(!1)}function y(j){j.length<1||oe(m)||k(f)||k(n)||(u(!0),setTimeout(()=>{const h=Array.from(Le(n,f));v(Object.keys(n).map(p=>{var c;return{name:p,displayName:((c=s.get(p))==null?void 0:c.displayName)??decodeURI(p),description:`${h.includes(p)?"Upstream":"Downstream"} | ${o.has(p)?"Directly":"Indirectly"} Connected`}})),u(!1)},300))}return t.jsxs("div",{className:D("w-full",a?"block absolute top-0 left-0 right-0 z-10 pr-10 bg-light dark:bg-dark @[40rem]:items-end @[40rem]:justify-end @[40rem]:flex @[40rem]:static @[40rem]:pr-0":"items-end justify-end flex"),children:[t.jsx(le,{shape:ye.Circle,className:D("flex @[40rem]:hidden !py-1 border-transparent",a?"hidden":"flex"),variant:re.Alternative,size:q.sm,"aria-label":"Show search",onClick:w,children:t.jsx(Pe,{className:"w-3 h-3 text-primary-500"})}),t.jsx(Oe,{list:m,placeholder:"Find",searchBy:"displayName",displayBy:"displayName",direction:"top",descriptionBy:"description",showIndex:!1,size:q.sm,onSelect:e,isLoading:g,className:D("w-full @sm:min-w-[12rem] @[40rem]:flex",a?"flex max-w-none":"hidden max-w-[20rem]"),isFullWidth:!0,onInput:y}),t.jsx("button",{className:D("flex @[40rem]:hidden bg-none border-none px-2 py-1 absolute right-0 top-0",a?"flex":"hidden"),"aria-label":"Hide search",onClick:b,children:t.jsx(_e,{className:"w-6 h-6 text-primary-500"})})]})}function ae({nodes:e=[]}){const{setCenter:s}=Z(),{activeNodes:n,models:f,mainNode:o,nodesMap:a,selectedNodes:x,setSelectedNodes:m,withImpacted:v,connectedNodes:g,lineageCache:u,setActiveEdges:w,setConnections:b,setLineage:y,setLineageCache:j}=_(),h=k(o)?void 0:f.get(o),p=n.size>0?n.size:g.size,c=x.size,d=g.size-1,r=e.filter(N=>N.hidden).length,C=e.filter(N=>P(N.hidden)&&(N.data.type===R.external||N.data.type===R.seed)).length,M=e.filter(N=>P(N.hidden)&&N.data.type===R.cte).length,E=p>0&&p!==d+1;function A(){if(k(o))return;const N=a[o];k(N)||setTimeout(()=>{s(N.position.x,N.position.y,{zoom:.5,duration:0})},200)}return t.jsxs(t.Fragment,{children:[G(h)&&t.jsx("a",{className:"mr-2 w-full whitespace-nowrap text-ellipsis overflow-hidden @lg:block font-bold text-neutral-600 dark:text-neutral-400 cursor-pointer hover:underline",onClick:A,children:je(h.displayName,50,25)}),t.jsxs("span",{className:"bg-neutral-5 px-2 py-0.5 flex rounded-full mr-2",children:[t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"All:"})," ",e.length]}),r>0&&t.jsxs("span",{className:"whitespace-nowrap block mr-2",children:[t.jsx("b",{children:"Hidden:"})," ",r]}),c>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Selected:"})," ",c]}),E&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Active:"})," ",p]}),(E||c>0)&&t.jsx(le,{size:q.xs,variant:re.Neutral,format:Ce.Ghost,className:"!m-0 px-1",onClick:()=>{w(new Map),b(new Map),m(new Set),G(u)&&(y(u),j(void 0))},children:"Reset"})]}),C>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Sources"}),": ",C]}),P(E)&&v&&c===0&&d>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Upstream/Downstream:"})," ",d]}),M>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"CTEs:"})," ",M]})]})}const rt=30;function Nt({model:e,highlightedNodes:s}){const{setActiveEdges:n,setConnections:f,setLineage:o,handleError:a,setSelectedNodes:x,setMainNode:m,setWithColumns:v,setHighlightedNodes:g,setNodeConnections:u,setLineageCache:w}=_(),{refetch:b,isFetching:y,cancel:j}=Ee(e.name),[h,p]=l.useState(!1);l.useEffect(()=>{const d=Ue();return d.addEventListener("message",c),b().then(({data:r})=>{if(k(r))return;Object.keys(r).length>rt&&v(!1),d.postMessage({topic:"lineage",payload:{currentLineage:{},newLineage:r,mainNode:e.fqn}}),p(!0)}).catch(r=>{a==null||a(r)}).finally(()=>{n(new Map),f(new Map),x(new Set),w(void 0),m(e.fqn)}),()=>{j==null||j(),d.removeEventListener("message",c),d.terminate(),o({}),u({}),m(void 0),g({})}},[e]),l.useEffect(()=>{g(s??{})},[s]);function c(d){d.data.topic==="lineage"&&(p(!1),u(d.data.payload.nodesConnections),o(d.data.payload.lineage)),d.data.topic==="error"&&(a==null||a(d.data.error),p(!1))}return t.jsxs("div",{className:"relative h-full w-full",children:[(y||h)&&t.jsx("div",{className:"absolute top-0 left-0 z-10 w-full h-full bg-theme flex justify-center items-center",children:t.jsxs(ie,{className:"inline-block",children:[t.jsx(ce,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md whitespace-nowrap",children:y?"Loading Model's Lineage...":"Merging Model's..."})]})}),t.jsx(Ie,{children:t.jsx(it,{})})]})}function it(){const{withColumns:e,lineage:s,mainNode:n,selectedEdges:f,selectedNodes:o,withConnected:a,withImpacted:x,withSecondary:m,hasBackground:v,activeEdges:g,connectedNodes:u,connections:w,nodesMap:b,handleError:y,setActiveNodes:j}=_(),{setCenter:h}=Z(),[p,c]=l.useState(!1),d=l.useMemo(()=>({model:ot}),[]),r=l.useMemo(()=>Ae(s),[s]),C=l.useMemo(()=>Be(s),[s]),[M,E]=l.useState([]),[A,N]=l.useState([]);l.useEffect(()=>{if(Q(r)||k(n))return;c(!0);const S=te(r,g,f,b),H=se(Object.values(b),S,n,u,o,w,a,x,m),W=ne(r,w,g,S,f,o,u,a,x,m),U=He({nodesMap:b,nodes:H,edges:W});return U.create().then(I=>{N(I.edges),E(I.nodes)}).catch(I=>{y==null||y(I),N([]),E([])}).finally(()=>{const I=k(n)?void 0:b[n];G(I)&&h(I.position.x,I.position.y,{zoom:.5,duration:0}),setTimeout(()=>{c(!1)},100)}),()=>{U.terminate(),N([]),E([])}},[g,b,C]),l.useEffect(()=>{if(k(n)||Q(M))return;const S=te(r,g,f,b),H=se(M,S,n,u,o,w,a,x,m),W=ne(r,w,g,S,f,o,u,a,x,m);N(W),E(H),j(S)},[w,b,r,g,o,f,u,a,x,m,e,n]);function K(S){E(De(S,M))}function T(S){N(Te(S,A))}return t.jsxs(t.Fragment,{children:[p&&t.jsxs("div",{className:"absolute top-0 left-0 z-10 flex justify-center items-center w-full h-full",children:[t.jsx("span",{className:"absolute w-full h-full z-10 bg-transparent-20 backdrop-blur-lg"}),t.jsxs(ie,{className:"inline-block z-10",children:[t.jsx(ce,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md whitespace-nowrap",children:"Building Lineage..."})]})]}),t.jsxs(Re,{nodes:M,edges:A,nodeTypes:d,onNodesChange:K,onEdgesChange:T,nodeOrigin:[.5,.5],minZoom:.05,maxZoom:1.5,snapGrid:[16,16],snapToGrid:!0,children:[t.jsxs(ue,{position:"top-right",className:"bg-theme !m-0 w-full !z-10",children:[t.jsx(ct,{nodes:M}),t.jsx(Me,{})]}),t.jsx(Je,{className:"bg-light p-1 rounded-md !border-none !shadow-lg"}),t.jsx(at,{variant:z.Cross,gap:32,size:4,className:D(v?"opacity-100":"opacity-0")})]})]})}function ct({nodes:e=[]}){const{withColumns:s,mainNode:n,selectedNodes:f,withConnected:o,withImpacted:a,withSecondary:x,hasBackground:m,activeNodes:v,highlightedNodes:g,setSelectedNodes:u,setWithColumns:w,setWithConnected:b,setWithImpacted:y,setWithSecondary:j,setHasBackground:h}=_(),p=l.useRef(null),c=l.useMemo(()=>Object.values(g??{}).flat(),[g]);function d(r){c.includes(r.name)||n===r.name||u(C=>(C.has(r.name)?C.delete(r.name):C.add(r.name),new Set(C)))}return t.jsxs("div",{className:"px-2 flex items-center text-xs text-neutral-400 @container",children:[t.jsxs("div",{className:"contents",children:[t.jsxs(X,{className:"flex @lg:hidden bg-none border-none","aria-label":"Show lineage node details",children:[t.jsxs(X.Button,{ref:p,className:"flex items-center relative w-full cursor-pointer bg-primary-10 text-xs rounded-full text-primary-500 py-1 px-3 text-center focus:outline-none focus-visible:border-accent-500 focus-visible:ring-2 focus-visible:ring-light focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-brand-300 border-1 border-transparent",children:["Details",t.jsx($e,{className:"ml-2 h-4 w-4","aria-hidden":"true"})]}),t.jsx(X.Panel,{className:"absolute left-2 right-2 flex-col z-50 mt-8 transform flex px-4 py-3 bg-theme-lighter shadow-xl focus:ring-2 ring-opacity-5 rounded-lg",children:t.jsx(ae,{nodes:e})})]}),t.jsx("div",{className:"hidden @lg:contents w-full",children:t.jsx(ae,{nodes:e})})]}),t.jsxs("div",{className:"flex w-full justify-end items-center",children:[t.jsx(lt,{handleSelect:d}),t.jsx(We,{options:{Background:h,Columns:v.size>0&&f.size===0?void 0:w,Connected:v.size>0?void 0:b,"Upstream/Downstream":v.size>0?void 0:y,All:v.size>0?void 0:j},value:[s&&"Columns",m&&"Background",o&&"Connected",a&&"Upstream/Downstream",x&&"All"].filter(Boolean)})]})]})}export{Nt as default};
