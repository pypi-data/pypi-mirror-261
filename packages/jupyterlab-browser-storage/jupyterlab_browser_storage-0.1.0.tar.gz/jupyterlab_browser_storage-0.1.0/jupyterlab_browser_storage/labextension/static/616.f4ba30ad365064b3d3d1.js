"use strict";(self.webpackChunkjupyterlab_browser_storage=self.webpackChunkjupyterlab_browser_storage||[]).push([[616],{616:(t,e,o)=>{o.r(e),o.d(e,{default:()=>v});var a,n,r=o(764),i=o(907),s=o(48),l=o(32),c=o(250),h=o(887),d=o.n(h),m=o(507),f=o(932),p=o(602),u=o(864),g=o.n(u);!function(t){t.JSON="application/json",t.PLAIN_TEXT="text/plain",t.OCTET_STREAM="octet/stream"}(a||(a={})),function(t){const e=JSON.parse("{}");t.getType=function(t,o=null){t=t.toLowerCase();for(const o of Object.values(e))for(const e of o.extensions||[])if(e===t&&o.mimeTypes&&o.mimeTypes.length)return o.mimeTypes[0];return g().getType(t)||o||a.OCTET_STREAM},t.hasFormat=function(t,o){t=t.toLowerCase();for(const a of Object.values(e))if(a.fileFormat===o)for(const e of a.extensions||[])if(e===t)return!0;return!1}}(n||(n={}));const w="BrowserStorage",_="JupyterLab Browser Storage";class y{constructor(t){this._isDisposed=!1,this._fileChanged=new p.Signal(this),this._storageName=_,this._storageDrivers=null,this._localforage=t.localforage,this._storageName=t.storageName||_,this._storageDrivers=t.storageDrivers||null,this._storage=this.createDefaultStorage(),this._counters=this.createDefaultCounters(),this._checkpoints=this.createDefaultCheckpoints()}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,p.Signal.clearData(this))}get name(){return w}get serverSettings(){return f.ServerConnection.makeSettings()}get fileChanged(){return this._fileChanged}async get(t,e){if(""===(t=decodeURIComponent(t.replace(/^\//,""))))return await this._getFolder(t);const o=this._storage,n=await o.getItem(t);if(!(null==e?void 0:e.content))return{size:0,...n,content:null};if("directory"===n.type){const e=new Map;await o.iterate(((o,a)=>{a===`${t}/${o.name}`&&e.set(o.name,o)}));const r=[...e.values()];return{name:m.PathExt.basename(t),path:t,last_modified:n.last_modified,created:n.created,format:"json",mimetype:a.JSON,content:r,size:0,writable:!0,type:"directory"}}return n}async getDownloadUrl(t){throw new Error("Method not implemented.")}async newUntitled(t){var e,o,r;const i=null!==(e=null==t?void 0:t.path)&&void 0!==e?e:"",s=null!==(o=null==t?void 0:t.type)&&void 0!==o?o:"notebook",l=(new Date).toISOString();let c=m.PathExt.dirname(i);const h=m.PathExt.basename(i),d=m.PathExt.extname(i),f=await this.get(c);let p,u="";switch(i&&!d&&f?(c=`${i}/`,u=""):c&&h?(c=`${c}/`,u=h):(c="",u=i),s){case"directory":u=`Untitled Folder${await this._incrementCounter("directory")||""}`,p={name:u,path:`${c}${u}`,last_modified:l,created:l,format:"json",mimetype:"",content:null,size:0,writable:!0,type:"directory"};break;case"notebook":{const t=await this._incrementCounter("notebook");u=u||`Untitled${t||""}.ipynb`,p={name:u,path:`${c}${u}`,last_modified:l,created:l,format:"json",mimetype:a.JSON,content:b.EMPTY_NB,size:JSON.stringify(b.EMPTY_NB).length,writable:!0,type:"notebook"};break}default:{const e=null!==(r=null==t?void 0:t.ext)&&void 0!==r?r:".txt",o=await this._incrementCounter("file"),i=n.getType(e)||a.OCTET_STREAM;let s;s=n.hasFormat(e,"text")||-1!==i.indexOf("text")?"text":-1!==e.indexOf("json")||-1!==e.indexOf("ipynb")?"json":"base64",u=u||`untitled${o||""}${e}`,p={name:u,path:`${c}${u}`,last_modified:l,created:l,format:s,mimetype:i,content:"",size:0,writable:!0,type:"file"};break}}const g=p.path;return await this._storage.setItem(g,p),p}async delete(t){const e=`${t=decodeURIComponent(t)}/`,o=(await this._storage.keys()).filter((o=>o===t||o.startsWith(e)));await Promise.all(o.map(this.forgetPath,this))}async rename(t,e){const o=decodeURIComponent(t),a=await this.get(o,{content:!0});if(!a)throw Error(`Could not find file with path ${o}`);const n=(new Date).toISOString(),r=m.PathExt.basename(e),i={...a,name:r,path:e,last_modified:n},s=this._storage;if(await s.setItem(e,i),await s.removeItem(o),await this._checkpoints.removeItem(o),"directory"===a.type){let e;for(e of a.content)await this.rename(m.URLExt.join(t,e.name),m.URLExt.join(t,e.name))}return i}async save(t,e){var o;t=decodeURIComponent(t);const a=m.PathExt.extname(null!==(o=null==e?void 0:e.name)&&void 0!==o?o:""),r=null==e?void 0:e.chunk,i=!!r&&(r>1||-1===r);let s=await this.get(t,{content:i});if(s||(s=await this.newUntitled({path:t,ext:a,type:"file"})),!s)throw Error("Could not create the file");const l=s.content,c=(new Date).toISOString();if(s={...s,...e,last_modified:c},(null==e?void 0:e.content)&&"base64"===(null==e?void 0:e.format)){const t=!r||-1===r;if(".ipynb"===a){const o=this._handleChunk(e.content,l,i);s={...s,content:t?JSON.parse(o):o,format:"json",type:"notebook",size:o.length}}else if(n.hasFormat(a,"json")){const o=this._handleChunk(e.content,l,i);s={...s,content:t?JSON.parse(o):o,format:"json",type:"file",size:o.length}}else if(n.hasFormat(a,"text")){const t=this._handleChunk(e.content,l,i);s={...s,content:t,format:"text",type:"file",size:t.length}}else{const t=e.content;s={...s,content:t,size:atob(t).length}}}return await this._storage.setItem(t,s),s}async copy(t,e){let o=m.PathExt.basename(t);for(e=""===e?"":`${e.slice(1)}/`;await this.get(`${e}${o}`,{content:!0});){const t=m.PathExt.extname(o),e=o.replace(t,"");o=`${e} (copy)${t}`}const a=`${e}${o}`;let n=await this.get(t,{content:!0});if(!n)throw Error(`Could not find file with path ${t}`);return n={...n,name:o,path:a},await this._storage.setItem(a,n),n}async createCheckpoint(t){var e;const o=this._checkpoints;t=decodeURIComponent(t);const a=await this.get(t,{content:!0});if(!a)throw Error(`Could not find file with path ${t}`);const n=(null!==(e=await o.getItem(t))&&void 0!==e?e:[]).filter(Boolean);return n.push(a),n.length>5&&n.splice(0,n.length-5),await o.setItem(t,n),{id:""+(n.length-1),last_modified:a.last_modified}}async listCheckpoints(t){return(await this._checkpoints.getItem(t)||[]).filter(Boolean).map(this.normalizeCheckpoint,this)}async restoreCheckpoint(t,e){t=decodeURIComponent(t);const o=(await this._checkpoints.getItem(t)||[])[parseInt(e)];await this._storage.setItem(t,o)}async deleteCheckpoint(t,e){t=decodeURIComponent(t);const o=await this._checkpoints.getItem(t)||[],a=parseInt(e);o.splice(a,1),await this._checkpoints.setItem(t,o)}get defaultStorageOptions(){const t=this._storageDrivers&&this._storageDrivers.length?this._storageDrivers:null;return{version:1,name:this._storageName,...t?{driver:t}:{}}}createDefaultStorage(){return this._localforage.createInstance({description:"Offline Storage for Notebooks and Files",storeName:"files",...this.defaultStorageOptions})}createDefaultCounters(){return this._localforage.createInstance({description:"Store the current file suffix counters",storeName:"counters",...this.defaultStorageOptions})}createDefaultCheckpoints(){return this._localforage.createInstance({description:"Offline Storage for Checkpoints",storeName:"checkpoints",...this.defaultStorageOptions})}async forgetPath(t){await Promise.all([this._storage.removeItem(t),this._checkpoints.removeItem(t)])}normalizeCheckpoint(t,e){return{id:e.toString(),last_modified:t.last_modified}}async _getFolder(t){const e=new Map,o=this._storage;return await o.iterate(((t,o)=>{o.includes("/")||e.set(t.path,t)})),{name:"",path:t,last_modified:new Date(0).toISOString(),created:new Date(0).toISOString(),format:"json",mimetype:a.JSON,content:Array.from(e.values()),size:0,writable:!0,type:"directory"}}async _incrementCounter(t){var e;const o=this._counters,a=(null!==(e=await o.getItem(t))&&void 0!==e?e:-1)+1;return await o.setItem(t,a),a}_handleChunk(t,e,o){const a=decodeURIComponent(escape(atob(t)));return o?e+a:a}}var b;!function(t){t.EMPTY_NB={metadata:{orig_nbformat:4},nbformat_minor:4,nbformat:4,cells:[]}}(b||(b={}));const C={id:"jupyterlab-browser-storage:plugin",requires:[i.IFileBrowserFactory,l.ITranslator],optional:[s.ISettingRegistry,r.IToolbarWidgetRegistry],autoStart:!0,activate:(t,e,o,a,n)=>{const{serviceManager:s}=t,{createFileBrowser:h}=e,m=o.load("jupyterlab-filesystem-access"),f=new y({localforage:d()});s.contents.addDrive(f);const p=h("jp-filesystem-browser",{driveName:f.name});p.title.caption=m.__("Browser Storage"),p.title.icon=c.listIcon;const u=p.toolbar;u.id="jp-browserstorage-toolbar",n&&a&&((0,r.setToolbar)(u,(0,r.createToolbarFactory)(n,a,w,C.id,null!=o?o:l.nullTranslator),u),n.addFactory(w,"uploader",(t=>new i.Uploader({model:p.model,translator:o}))),n.addFactory(w,"filename-searcher",(t=>{const e=(0,c.FilenameSearcher)({updateFilter:(t,e)=>{p.model.setFilter((e=>t(e.name.toLowerCase())))},useFuzzyFilter:!0,placeholder:m.__("Filter files by name"),forceRefresh:!1});return e.addClass("jp-FileBrowser-filterBox"),e}))),t.shell.add(p,"left",{type:"BrowserStorage"})}},v=C}}]);