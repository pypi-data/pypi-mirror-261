const _=new Error("request for lock canceled");var d=function(o,e,t,i){function u(r){return r instanceof t?r:new t(function(n){n(r)})}return new(t||(t=Promise))(function(r,n){function c(s){try{h(i.next(s))}catch(a){n(a)}}function l(s){try{h(i.throw(s))}catch(a){n(a)}}function h(s){s.done?r(s.value):u(s.value).then(c,l)}h((i=i.apply(o,e||[])).next())})};class f{constructor(e,t=_){this._value=e,this._cancelError=t,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((t,i)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:t,reject:i}),this._dispatch()})}runExclusive(e,t=1){return d(this,void 0,void 0,function*(){const[i,u]=yield this.acquire(t);try{return yield e(i)}finally{u()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(t=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(t),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(t=>t.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let t=this._value;t>0;t--){const i=(e=this._weightedQueues[t-1])===null||e===void 0?void 0:e.shift();if(!i)continue;const u=this._value,r=t;this._value-=t,t=this._value+1,i.resolve([u,this._newReleaser(r)])}this._drainUnlockWaiters()}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(t=>t()),this._weightedWaiters[e-1]=[])}}var v=function(o,e,t,i){function u(r){return r instanceof t?r:new t(function(n){n(r)})}return new(t||(t=Promise))(function(r,n){function c(s){try{h(i.next(s))}catch(a){n(a)}}function l(s){try{h(i.throw(s))}catch(a){n(a)}}function h(s){s.done?r(s.value):u(s.value).then(c,l)}h((i=i.apply(o,e||[])).next())})};class w{constructor(e){this._semaphore=new f(1,e)}acquire(){return v(this,void 0,void 0,function*(){const[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}export{w as M};
