name: Release to GitHub and PyPI

on:
  push:
    tags: [v*]

jobs:
  release:
    runs-on: ubuntu-latest
    environment: release
    permissions: write-all

    steps:
    - name: Check out repository
      uses: actions/checkout@v3
    
    - name: Install rye
      uses: eifinger/setup-rye@v2
      with:
        enable-cache: true

    - run: rye sync --no-lock
    - run: rye build

    - name: Create release
      uses: marvinpinto/action-automatic-releases@v1.2.1
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"        
        prerelease: false
        files: |
          dist/*.whl
          dist/*.tar.gz

    - name: Publish package to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true
