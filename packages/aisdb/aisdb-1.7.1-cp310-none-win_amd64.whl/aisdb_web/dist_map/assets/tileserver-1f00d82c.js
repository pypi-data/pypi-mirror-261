import{T as w,e as M,c as R,a as A,b as F}from"./TileImage-d1e95ef2.js";import{g as z,a as U,b as C,i as E}from"./proj-20c50701.js";import{tileserver_hostname as a}from"./constants-36dce06f.js";import"./map-704b8d69.js";import"./main-17f2d9e3.js";function G(u){const e=u[0],t=new Array(e);let o=1<<e-1,i=null,r=null;for(r=0;r<e;++r)i=48,u[1]&o&&(i=i+1),u[2]&o&&(i=i+2),t[r]=String.fromCharCode(i),o=o>>1;return t.join("")}const k='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class W extends w{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,opaque:!0,projection:z("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:function(i,r){const[l,m,h,d]=r.replace("https://","").split(/[/?]+/);r=a===""||a==="/"?`/${m}/${h}?${d}`:`https://${a}/${m}/${h}?${d}`,i.src_=r,i.getImage().src=r},tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.imagerySet_="Aerial";let o=null;a!==""&&a!=="/"?o=`https://${a}/REST/v1/Imagery/Metadata/${this.imagerySet_}?uriScheme=https&include=ImageryProviders&c=${this.culture_}`:(console.log(`info: got tileserver hostname ${a}. Defaulting...`),o=`https://dev.virtualearth.net/REST/v1/Imagery/Metadata/${this.imagerySet_}?uriScheme=https&include=ImageryProviders&key=${this.apiKey_}&c=${this.culture_}`),fetch(o).then(i=>i.json()).then(i=>this.handleImageryMetadataResponse(i))}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!==200||e.statusDescription!=="OK"||e.authenticationResultCode!=="ValidCredentials"||e.resourceSets.length!==1||e.resourceSets[0].resources.length!==1){this.setState("error");return}const t=e.resourceSets[0].resources[0],o=this.maxZoom_===-1?t.zoomMax:this.maxZoom_,i=this.getProjection(),r=M(i),l=this.hidpi_?2:1,m=t.imageWidth===t.imageHeight?t.imageWidth/l:[t.imageWidth/l,t.imageHeight/l],h=R({extent:r,minZoom:t.zoomMin,maxZoom:o,tileSize:m});this.tileGrid=h;const d=this.culture_,j=this.hidpi_;if(this.tileUrlFunction=A(t.imageUrlSubdomains.map(f=>{const n=[0,0,0],c=t.imageUrl.replace("{subdomain}",f).replace("{culture}",d);return function(s,S,_){if(!s)return;F(s[0],s[1],s[2],n);let g=c;return j&&(g=`${g}&dpi=d1&device=mobile`),g.replace("{quadkey}",G(n))}})),t.imageryProviders){const f=U(z("EPSG:4326"),this.getProjection());this.setAttributions(n=>{const c=[],s=n.viewState,S=this.getTileGrid(),_=S.getZForResolution(s.resolution,this.zDirection),b=S.getTileCoordForCoordAndZ(s.center,_)[0];return t.imageryProviders.map(T=>{let v=!1;const $=T.coverageAreas;for(let x=0,I=$.length;x<I;++x){const y=$[x];if(b>=y.zoomMin&&b<=y.zoomMax){const p=y.bbox,P=[p[1],p[0],p[3],p[2]],Z=C(P,f);if(E(Z,n.extent)){v=!0;break}}}v&&c.push(T.attribution)}),c.push(k),c})}this.setState("ready")}}export{W as CustomBingMaps};
